
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>BagBuddy - Smart Packing Lists</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light theme (default) */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --success-color: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --danger-color: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --sticky-bg: linear-gradient(to bottom, var(--bg-primary) 0%, var(--bg-primary) 85%, transparent 100%);
            --title-gradient: linear-gradient(135deg, #f97316 0%, #ec4899 100%);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --accent-primary: #818cf8;
            --accent-secondary: #a78bfa;
            --accent-gradient: linear-gradient(135deg, #818cf8 0%, #a78bfa 100%);
            --success-color: #34d399;
            --success-bg: rgba(52, 211, 153, 0.15);
            --danger-color: #f87171;
            --danger-bg: rgba(248, 113, 113, 0.15);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --sticky-bg: linear-gradient(to bottom, var(--bg-primary) 0%, var(--bg-primary) 85%, transparent 100%);
            --title-gradient: linear-gradient(135deg, #fbbf24 0%, #f472b6 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.7;
            -webkit-font-smoothing: antialiased;
            transition: background 0.3s, color 0.3s;
        }

        body.no-scroll {
            overflow: hidden;
            height: 100vh;
        }

        /* Hide scrollbars but keep scrolling */
        .left-column::-webkit-scrollbar,
        .right-column::-webkit-scrollbar {
            display: none;
        }
        .left-column, .right-column {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE/Edge */
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .container.wide {
            max-width: 100%;
            height: 100vh;
            padding: 16px 24px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .theme-toggle {
            position: fixed;
            top: 16px;
            right: 16px;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            background: var(--bg-secondary);
            font-size: 20px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            border-color: var(--accent-primary);
            transform: scale(1.05);
        }

        .hero {
            text-align: center;
            padding: 40px 20px;
        }

        body.no-scroll .hero {
            display: none;
        }

        .hero-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .hero h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            font-weight: 600;
            background: var(--title-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .hero-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .prep-actions {
            margin: 0 auto 16px;
            max-width: 600px;
        }

        .prep-actions button {
            width: 100%;
            display: block;
        }

        body.no-scroll .prep-actions {
            display: none;
        }

        /* Trips Browser */
        .trips-browser {
            margin: 0 auto 24px;
            max-width: 600px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .trips-browser-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .trips-browser-header:hover {
            background: var(--bg-hover);
        }

        .trips-browser-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .trips-browser-toggle {
            color: var(--text-muted);
            transition: transform 0.2s;
        }

        .trips-browser.expanded .trips-browser-toggle {
            transform: rotate(180deg);
        }

        .trips-browser-content {
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        .trips-browser.expanded .trips-browser-content {
            display: block;
        }

        .trips-filter {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .trips-filter label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .trips-list {
            padding: 8px;
        }

        .trips-empty {
            padding: 24px;
            text-align: center;
            color: var(--text-muted);
        }

        .trip-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 4px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .trip-item:hover {
            border-color: var(--accent-primary);
            background: var(--bg-hover);
        }

        .trip-item.archived {
            opacity: 0.7;
            background: var(--bg-tertiary);
        }

        .trip-item-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }

        .trip-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-family: monospace;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trip-item-name .archived-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: var(--warning-bg);
            color: var(--warning-color);
            font-family: system-ui;
        }

        .trip-item-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .trip-item-actions {
            display: flex;
            gap: 6px;
        }

        .trip-item-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trip-item-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .trip-item-btn.danger:hover {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .trip-item-btn.primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .trip-item-btn.primary:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .trip-id-badge {
            display: inline-block;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 12px;
            font-family: monospace;
        }

        .trip-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            padding: 8px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .trip-bar .app-title {
            font-size: 0.9rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .trip-bar .app-title span {
            font-size: 1.1rem;
        }

        .trip-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .trip-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
            font-family: monospace;
        }

        .save-status {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .save-status.saving {
            color: var(--accent-primary);
        }

        .save-status.saved {
            color: var(--success-color);
        }

        .trip-actions {
            display: flex;
            gap: 8px;
        }

        .trip-btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trip-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .trip-btn.danger:hover {
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        /* Floating Action Buttons */
        .fab-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        .fab {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }

        .fab:hover {
            transform: scale(1.1);
        }

        .fab.progress-fab {
            background: var(--success-color);
            color: white;
            position: relative;
        }

        .fab.progress-fab .progress-ring {
            position: absolute;
            inset: 0;
            border-radius: 16px;
            border: 3px solid transparent;
            border-top-color: white;
        }

        .fab.ai-fab {
            background: var(--accent-gradient);
            color: white;
        }

        .fab.todoist-fab {
            background: #e44332;
            color: white;
        }

        .fab-label {
            position: absolute;
            right: 68px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .fab:hover .fab-label {
            opacity: 1;
        }

        /* Popup Modal */
        .popup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .popup-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .popup {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .popup-overlay.active .popup {
            transform: scale(1);
        }

        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .popup-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .popup-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 4px;
        }

        .popup-close:hover {
            color: var(--text-primary);
        }

        /* Prompt Management */
        .prompt-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .prompt-btn {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .prompt-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .prompt-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .prompt-item:hover {
            background: var(--bg-primary);
        }

        .prompt-item.selected {
            border: 2px solid var(--accent-primary);
        }

        .prompt-item-info {
            flex: 1;
        }

        .prompt-item-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .prompt-item-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .prompt-item-actions {
            display: flex;
            gap: 4px;
        }

        .prompt-item-btn {
            padding: 4px 8px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
        }

        .prompt-item-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .prompt-item-btn.danger:hover {
            color: var(--danger-color);
        }

        /* Generation Progress */
        .generation-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .generation-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .generation-content {
            text-align: center;
            color: white;
        }

        .generation-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .generation-title {
            font-size: 1.4rem;
            margin-bottom: 8px;
        }

        .generation-subtitle {
            color: rgba(255,255,255,0.7);
            margin-bottom: 20px;
        }

        .generation-progress-bar {
            width: 300px;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 auto;
        }

        .generation-progress-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 4px;
            transition: width 0.3s linear;
        }

        .generation-time {
            margin-top: 12px;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.6);
        }

        .section {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .section-icon {
            font-size: 24px;
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            font-weight: 600;
            background: var(--title-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .destination-container {
            position: relative;
        }

        .destination-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.2s;
        }

        .destination-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .destination-input::placeholder {
            color: var(--text-muted);
        }

        .destination-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            margin-top: 4px;
        }

        .destination-suggestion {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
        }

        .destination-suggestion:hover {
            background: var(--bg-hover);
        }

        .trip-type-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .trip-type-option {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .trip-type-option:hover {
            border-color: var(--accent-primary);
        }

        .trip-type-option.selected {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-primary);
        }

        .trip-type-option input {
            display: none;
        }

        .trip-type-name {
            font-weight: 500;
            font-size: 1rem;
            margin-bottom: 4px;
            color: var(--text-primary);
        }

        .trip-type-desc {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .slider-row {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .days-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-tertiary);
            border-radius: 4px;
            outline: none;
        }

        .days-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-gradient);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        .days-slider::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            border: none;
        }

        .days-value {
            font-size: 2rem;
            font-weight: 600;
            min-width: 80px;
            text-align: center;
            background: var(--title-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            padding: 0 14px;
        }

        /* Strategy selector */
        .strategy-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.95rem;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
        }

        .strategy-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .prompt-editor {
            width: 100%;
            padding: 12px 14px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            resize: vertical;
            min-height: 200px;
        }

        .prompt-editor:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .toggle-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .toggle-item {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .toggle-item:hover {
            border-color: var(--text-muted);
        }

        .toggle-item.active {
            background: var(--success-bg);
            border-color: var(--success-color);
        }

        .toggle-item input {
            display: none;
        }

        .toggle-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .toggle-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .toggle-item.active .toggle-label {
            color: var(--success-color);
        }

        .btn-generate {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 12px;
            background: var(--accent-gradient);
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .btn-generate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Results Section */
        #results {
            display: none;
            flex: 1;
            min-height: 0;
            flex-direction: column;
        }

        #results.active {
            display: flex;
        }

        #results > .section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            margin-bottom: 0;
        }

        .results-layout {
            display: flex;
            gap: 0;
            align-items: stretch;
            flex: 1;
            min-height: 0;
        }

        .left-column {
            flex: 1;
            min-width: 300px;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-primary);
            border-radius: 12px;
        }

        .resize-handle {
            width: 8px;
            background: var(--border-color);
            cursor: col-resize;
            border-radius: 4px;
            margin: 0 8px;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .resize-handle:hover,
        .resize-handle.dragging {
            background: var(--accent-primary);
        }

        .right-column {
            width: 400px;
            min-width: 280px;
            max-width: 600px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        @media (max-width: 900px) {
            .results-layout {
                flex-direction: column;
                height: auto;
            }
            .left-column {
                padding-right: 0;
            }
            .resize-handle {
                display: none;
            }
            .right-column {
                width: 100%;
                max-width: none;
                margin-top: 16px;
            }
        }

        .top-bar {
            margin-bottom: 16px;
        }

        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: var(--sticky-bg);
            padding: 12px 0 16px 0;
            margin: -12px -24px 16px -24px;
            padding-left: 24px;
            padding-right: 24px;
        }

        .drop-zones {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .drop-zone {
            width: 72px;
            height: 72px;
            border: 3px dashed var(--border-color);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: var(--bg-secondary);
        }

        .drop-zone:hover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .drop-zone.drag-over {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.15);
            transform: scale(1.1);
        }

        .drop-zone-icon {
            font-size: 48px;
        }

        .drop-zone-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .drop-zone-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--accent-primary);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .drop-zone.trash:hover, .drop-zone.trash.drag-over {
            border-color: var(--danger-color);
            background: var(--danger-bg);
        }

        /* Packing Cubes */
        .cubes-section {
            margin-bottom: 0;
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }

        .cubes-header {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .cubes-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .cubes-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .add-cube-btn {
            padding: 5px 10px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-cube-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .search-input {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.8rem;
            width: 140px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            width: 180px;
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-container {
            position: relative;
        }

        .search-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            min-width: 280px;
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 100;
            margin-top: 4px;
        }

        .search-result {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .search-result:last-child {
            border-bottom: none;
        }

        .search-result:hover {
            background: var(--bg-hover);
        }

        .search-result-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .search-result-location {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .search-result-type {
            display: inline-block;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .search-result-type.bag {
            background: var(--accent-primary);
            color: white;
        }

        .search-notice {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--accent-primary);
            border-radius: 12px;
            padding: 12px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideUp 0.3s ease-out;
        }

        .search-notice-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-notice-text {
            color: var(--text-primary);
        }

        .search-notice-path {
            font-weight: 600;
            color: var(--accent-primary);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .packing-cube.search-highlight {
            animation: pulse-highlight 1s ease-in-out infinite;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
        }

        @keyframes pulse-highlight {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
            50% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }
        }

        .summary-btn {
            padding: 6px 12px;
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .summary-btn:hover {
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .summary-btn:disabled {
            opacity: 0.5;
            cursor: wait;
        }

        .packing-summary {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .summary-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.3rem;
            cursor: pointer;
        }

        .summary-content {
            color: var(--text-secondary);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .summary-content h4 {
            color: var(--text-primary);
            margin: 12px 0 8px 0;
        }

        .summary-content ul {
            margin: 0;
            padding-left: 20px;
        }

        .cubes-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            padding: 10px 0;
        }

        .cubes-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cubes-actions .drop-zone.trash {
            width: 96px;
            height: 96px;
            min-width: 96px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .cubes-actions .drop-zone.trash .drop-zone-icon {
            font-size: 2.4rem;
        }

        .packing-cube {
            min-width: 90px;
            min-height: 90px;
            padding: 12px;
            padding-bottom: 16px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            gap: 4px;
        }

        /* Pastel color palette for bags */
        .packing-cube.color-0 { background: linear-gradient(135deg, #a8d8ea 0%, #aa96da 100%); }
        .packing-cube.color-1 { background: linear-gradient(135deg, #fcbad3 0%, #aa96da 100%); }
        .packing-cube.color-2 { background: linear-gradient(135deg, #ffffd2 0%, #fcbad3 100%); }
        .packing-cube.color-3 { background: linear-gradient(135deg, #a8d8ea 0%, #caffbf 100%); }
        .packing-cube.color-4 { background: linear-gradient(135deg, #ffd6a5 0%, #fdffb6 100%); }
        .packing-cube.color-5 { background: linear-gradient(135deg, #bdb2ff 0%, #ffc6ff 100%); }
        .packing-cube.color-6 { background: linear-gradient(135deg, #9bf6ff 0%, #a0c4ff 100%); }
        .packing-cube.color-7 { background: linear-gradient(135deg, #ffadad 0%, #ffd6a5 100%); }

        /* Size based on weight - dramatic scaling with minimum for legibility */
        .packing-cube.size-small {
            width: 100px;
            height: 115px;
        }

        .packing-cube.size-small .cube-icon {
            font-size: 28px;
        }

        .packing-cube.size-small .cube-name {
            font-size: 0.75rem;
        }

        .packing-cube.size-medium {
            width: 105px;
            height: 120px;
        }

        .packing-cube.size-large {
            width: 130px;
            height: 130px;
        }

        .packing-cube.size-xlarge {
            width: 170px;
            height: 170px;
        }

        .packing-cube.size-xxlarge {
            width: 220px;
            height: 220px;
        }

        .cube-weight {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 8px;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .packing-cube:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .packing-cube.drag-over {
            transform: scale(1.08);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        }

        .packing-cube.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        /* Drop animation - gulp effect */
        @keyframes gulp {
            0% { transform: scale(1.08); }
            15% { transform: scale(1.2) rotate(-3deg); }
            30% { transform: scale(0.9) rotate(2deg); }
            45% { transform: scale(1.15) rotate(-1deg); }
            60% { transform: scale(0.95); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes sparkle {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7), 0 4px 15px rgba(0, 0, 0, 0.2); }
            50% { box-shadow: 0 0 20px 10px rgba(255, 215, 0, 0.4), 0 4px 15px rgba(0, 0, 0, 0.2); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0), 0 4px 15px rgba(0, 0, 0, 0.2); }
        }

        .packing-cube.drop-received {
            animation: gulp 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97), sparkle 0.6s ease-out;
        }

        .cube-icon {
            font-size: 32px;
        }

        .cube-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.7);
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            word-break: break-word;
            line-height: 1.2;
        }

        .cube-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--accent-primary);
            color: white;
            border-radius: 50%;
            min-width: 24px;
            height: 24px;
            padding: 0 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .cube-location {
            position: absolute;
            bottom: -5px;
            right: -5px;
            font-size: 10px;
        }

        /* Emoji Picker */
        .emoji-picker-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .emoji-picker-overlay.visible {
            display: flex;
        }

        .emoji-picker {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 24px;
            max-width: 350px;
            width: 90%;
            box-shadow: var(--card-shadow);
        }

        .emoji-picker-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            margin-bottom: 16px;
            text-align: center;
            color: var(--text-primary);
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .emoji-option {
            width: 44px;
            height: 44px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-tertiary);
            font-size: 24px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-option:hover {
            border-color: var(--text-muted);
            background: var(--bg-primary);
        }

        .emoji-option.selected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.15);
        }

        .cube-name-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.95rem;
            margin-bottom: 16px;
        }

        .cube-name-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .emoji-picker-actions {
            display: flex;
            gap: 10px;
        }

        .emoji-picker-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-create-cube {
            background: var(--accent-gradient);
            color: white;
        }

        .btn-cancel-cube {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        /* Modal cube section */
        .modal-section {
            margin-bottom: 16px;
        }

        .modal-section-title {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .modal-cube {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .modal-cube-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .modal-cube-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .modal-cube-items {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding-left: 12px;
            border-left: 2px solid var(--border-color);
        }

        .modal-cube-item {
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .item.in-cube {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .item-location {
            font-size: 0.85rem;
            margin-right: 2px;
        }

        .category {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .category-icon {
            font-size: 20px;
        }

        .category-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .item-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .add-item-inline {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--accent-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.7;
        }

        .add-item-inline:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        .inline-add-input {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .inline-add-input input {
            padding: 6px 10px;
            border: 2px solid var(--accent-primary);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            width: 120px;
            outline: none;
        }

        .inline-add-input button {
            padding: 6px 10px;
            border: none;
            border-radius: 8px;
            background: var(--accent-primary);
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .inline-add-input .cancel-btn {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 14px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
            color: var(--text-primary);
        }

        .item.touch-dragging {
            position: fixed;
            z-index: 1000;
            opacity: 0.9;
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            pointer-events: none;
        }

        .item.selected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.12);
        }

        .item.touch-origin {
            opacity: 0.3;
        }

        .item:hover {
            border-color: var(--text-muted);
            background: var(--bg-secondary);
        }

        .item.packed {
            text-decoration: line-through;
            opacity: 0.6;
            background: var(--success-bg);
            border-color: var(--success-color);
        }

        .item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .item-count {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent-primary);
            border-radius: 6px;
            padding: 2px 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .item-count:hover {
            background: rgba(99, 102, 241, 0.4);
            transform: scale(1.1);
        }

        .item-weight {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
            border-radius: 6px;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: auto;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .item-weight:hover {
            background: rgba(16, 185, 129, 0.4);
            transform: scale(1.1);
        }

        .item-name {
            cursor: pointer;
            flex: 1;
        }

        .item-name:hover {
            text-decoration: underline;
        }

        /* Weight-based item sizing - dramatic scaling */
        .item.weight-tiny {
            padding: 4px 8px;
            font-size: 0.75rem;
            min-height: 28px;
        }

        .item.weight-small {
            padding: 6px 12px;
            font-size: 0.85rem;
            min-height: 32px;
        }

        .item.weight-medium {
            padding: 10px 16px;
            font-size: 0.95rem;
            min-height: 40px;
        }

        .item.weight-large {
            padding: 14px 20px;
            font-size: 1.1rem;
            min-height: 50px;
            border-width: 2px;
        }

        .item.weight-heavy {
            padding: 18px 24px;
            font-size: 1.2rem;
            min-height: 60px;
            border-width: 3px;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, rgba(99, 102, 241, 0.1) 100%);
        }

        .item.in-suitcase .item-count,
        .item.in-backpack .item-count {
            display: none;
        }

        .item.in-suitcase::before {
            content: '';
            font-size: 0.8rem;
        }

        .item.in-backpack::before {
            content: '';
            font-size: 0.8rem;
        }

        .add-item-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .add-item-row {
            display: flex;
            gap: 8px;
        }

        .add-item-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .add-item-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .add-item-btn {
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            background: var(--accent-gradient);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-item-btn:hover {
            transform: translateY(-1px);
        }

        .category-select {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 120px;
        }

        .category-select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .add-category-btn {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .add-category-btn:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        /* Model badge section */
        .prompt-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        /* AI Action input */
        .ai-action-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .ai-action-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .ai-action-title {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .ai-action-row {
            display: flex;
            gap: 8px;
        }

        .ai-action-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .ai-action-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .ai-action-input::placeholder {
            color: var(--text-muted);
        }

        .ai-action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .ai-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .ai-action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Modal for viewing bag contents */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--card-shadow);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .modal-item {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            color: var(--text-primary);
        }

        .modal-item-remove {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            font-size: 1rem;
        }

        .empty-bag {
            color: var(--text-muted);
            text-align: center;
            padding: 20px;
        }

        .modal-add-section {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        .modal-add-input {
            flex: 1;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .modal-add-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .modal-add-btn {
            background: var(--accent-primary);
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .modal-add-btn:hover {
            background: var(--accent-secondary);
        }

        /* Weight modal */
        .weight-modal-content {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .weight-input-group {
            display: flex;
            align-items: center;
            gap: 12px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 4px;
        }

        .weight-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 14px 16px;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
            width: 100%;
        }

        .weight-input:focus {
            outline: none;
        }

        .weight-input::placeholder {
            color: var(--text-muted);
            font-weight: 400;
        }

        .weight-unit {
            color: var(--text-muted);
            font-size: 0.9rem;
            padding-right: 16px;
        }

        .weight-modal-actions {
            display: flex;
            gap: 10px;
        }

        .weight-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .weight-btn-estimate {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .weight-btn-estimate:hover {
            background: rgba(16, 185, 129, 0.25);
        }

        .weight-btn-estimate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .weight-btn-save {
            background: var(--accent-primary);
            color: white;
        }

        .weight-btn-save:hover {
            background: var(--accent-secondary);
        }

        /* Sub-bags in modal */
        .modal-sub-bag {
            background: var(--accent-primary);
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid var(--accent-primary);
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-sub-bag:hover {
            background: rgba(99, 102, 241, 0.25);
        }

        .modal-sub-bag-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-sub-bag-count {
            background: var(--accent-primary);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.8rem;
        }

        .progress-bar {
            background: var(--bg-tertiary);
            border-radius: 10px;
            height: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-bottom: 16px;
        }

        .save-section {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .input-text {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .input-text:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .input-text::placeholder {
            color: var(--text-muted);
        }

        .btn-save {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--success-color) 0%, #059669 100%);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
        }

        .btn-save:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-reset {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .btn-reset:hover {
            border-color: var(--text-muted);
            color: var(--text-primary);
        }

        .status-message {
            padding: 14px;
            border-radius: 10px;
            margin-top: 12px;
            text-align: center;
            display: none;
        }

        .status-message.success {
            background: var(--success-bg);
            color: var(--success-color);
            display: block;
        }

        .status-message.error {
            background: var(--danger-bg);
            color: var(--danger-color);
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: var(--bg-secondary); border-radius: 16px; padding: 40px; max-width: 450px; width: 100%; box-shadow: var(--card-shadow); border: 1px solid var(--border-color);">
            <h1 style="font-family: 'Playfair Display', serif; font-size: 2rem; background: var(--title-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-align: center; margin-bottom: 8px;"> BagBuddy</h1>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 24px;">Smart packing lists powered by AI</p>
            <input type="password" id="api-key-input" placeholder="Enter your OpenAI API key" style="width: 100%; padding: 14px 16px; border-radius: 10px; border: 2px solid var(--border-color); background: var(--bg-primary); color: var(--text-primary); font-size: 1rem; margin-bottom: 16px; font-family: monospace;">
            <button onclick="validateAndSaveKey(document.getElementById('api-key-input').value)" style="width: 100%; padding: 14px; border-radius: 10px; border: none; background: var(--accent-gradient); color: white; font-size: 1rem; font-weight: 600; cursor: pointer;">Start Packing</button>
            <div style="margin-top: 24px; padding: 16px; background: var(--bg-tertiary); border-radius: 10px; font-size: 0.85rem; color: var(--text-secondary);">
                <strong style="color: var(--success-color);"> Your data stays local</strong><br>
                All trips stored in your browser. API key only sent to OpenAI.<br><br>
                <strong style="color: var(--text-primary);"> Typical cost: ~$0.02-0.10 per trip</strong><br>
                List generation uses GPT-4o (~$0.03), weight estimation and summaries use GPT-4o-mini (~$0.001 each).<br><br>
                <a href="https://platform.openai.com/api-keys" target="_blank" style="color: var(--accent-primary);">Get an API key </a>
            </div>
        </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="main-app" style="display: none;">
    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
        <span id="theme-icon"></span>
    </button>
    <button class="logout-btn" onclick="logout()" style="position: fixed; top: 16px; right: 70px; padding: 10px 16px; border-radius: 10px; border: 2px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); font-size: 0.85rem; cursor: pointer; z-index: 100;">Logout</button>

    <div class="container">
        <div class="hero">
            <div class="hero-icon"></div>
            <h1>BagBuddy</h1>
            <p class="hero-subtitle">Never forget what to pack again</p>
        </div>

        <div class="prep-actions">
            <button class="prompt-btn" onclick="openPreparationManager()"> Saved Preparations</button>
        </div>

        <div class="trips-browser" id="trips-browser">
            <div class="trips-browser-header" onclick="toggleTripsBrowser()">
                <span class="trips-browser-title">
                    <span></span>
                    <span>My Trips</span>
                    <span id="trips-count" style="font-weight: normal; color: var(--text-muted);"></span>
                </span>
                <span class="trips-browser-toggle"></span>
            </div>
            <div class="trips-browser-content">
                <div class="trips-filter" style="display: flex; justify-content: space-between; align-items: center;">
                    <label>
                        <input type="checkbox" id="show-archived" onchange="loadTrips()">
                        Show archived
                    </label>
                    <div style="display: flex; gap: 8px;">
                        <button onclick="document.getElementById('import-file').click()" style="padding: 4px 10px; font-size: 0.8rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Import</button>
                        <button onclick="exportAllTrips()" style="padding: 4px 10px; font-size: 0.8rem; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer;">Export All</button>
                    </div>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importTripFile(event)">
                </div>
                <div class="trips-list" id="trips-list">
                    <div class="trips-empty">Loading trips...</div>
                </div>
            </div>
        </div>

        <div id="form-section">
            <div class="section">
                <div class="section-header">
                    <span class="section-icon"></span>
                    <span class="section-title">Trip Type</span>
                </div>

                <div class="trip-type-grid">
                    <label class="trip-type-option selected" data-value="solo_day">
                        <input type="radio" name="trip_type" value="solo_day" checked>
                        <div class="trip-type-name">Solo Day Trip</div>
                        <div class="trip-type-desc">Quick getaway, back the same day</div>
                    </label>
                    <label class="trip-type-option" data-value="solo_multi">
                        <input type="radio" name="trip_type" value="solo_multi">
                        <div class="trip-type-name">Solo Multi-Day Trip</div>
                        <div class="trip-type-desc">Personal adventure for multiple days</div>
                    </label>
                    <label class="trip-type-option" data-value="family_multi">
                        <input type="radio" name="trip_type" value="family_multi">
                        <div class="trip-type-name">Family Multi-Day Trip</div>
                        <div class="trip-type-desc">Family vacation with extra gear</div>
                    </label>
                </div>
            </div>

            <div class="section" id="days-section" style="display: none;">
                <div class="section-header">
                    <span class="section-icon"></span>
                    <span class="section-title">Duration</span>
                </div>

                <div class="form-group">
                    <label class="form-label">How many days?</label>
                    <div class="slider-container">
                        <div class="slider-row">
                            <input type="range" class="days-slider" id="days-slider" min="1" max="10" value="2" oninput="updateDays(this.value)">
                            <span class="days-value" id="days-display">2 days</span>
                        </div>
                        <div class="slider-labels">
                            <span>1</span>
                            <span>5</span>
                            <span>10</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <span class="section-icon"></span>
                    <span class="section-title">Destination</span>
                </div>

                <div class="form-group">
                    <div class="destination-container">
                        <input type="text" class="destination-input" id="destination-input" placeholder="Where are you going? (e.g., San Francisco)" autocomplete="off" oninput="filterDestinations(this.value)" onfocus="showDestinationSuggestions()">
                        <div class="destination-autocomplete" id="destination-autocomplete" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <span class="section-icon"></span>
                    <span class="section-title">Trip Options</span>
                </div>

                <div class="toggle-grid">
                    <div class="toggle-item" data-option="is_work_trip">
                        <div class="toggle-icon"></div>
                        <div class="toggle-label">Work Trip</div>
                    </div>
                    <div class="toggle-item" data-option="is_international" id="international-toggle" style="display: none;">
                        <div class="toggle-icon"></div>
                        <div class="toggle-label">International</div>
                    </div>
                    <div class="toggle-item" data-option="outside_time">
                        <div class="toggle-icon"></div>
                        <div class="toggle-label">Time Outside</div>
                    </div>
                    <div class="toggle-item" data-option="beach_pool">
                        <div class="toggle-icon"></div>
                        <div class="toggle-label">Beach/Pool</div>
                    </div>
                    <div class="toggle-item" data-option="formal">
                        <div class="toggle-icon"></div>
                        <div class="toggle-label">Formal Event</div>
                    </div>
                    <div class="toggle-item" data-option="cold_wet">
                        <div class="toggle-icon"></div>
                        <div class="toggle-label">Cold/Wet</div>
                    </div>
                    <div class="toggle-item" data-option="pajamas" id="pajamas-toggle" style="display: none;">
                        <div class="toggle-icon"></div>
                        <div class="toggle-label">Pajamas</div>
                    </div>
                    <div class="toggle-item" data-option="valet" id="valet-toggle" style="display: none;">
                        <div class="toggle-icon"></div>
                        <div class="toggle-label">Valet Parking</div>
                    </div>
                    <div class="toggle-item" data-option="recording" id="recording-toggle" style="display: none;">
                        <div class="toggle-icon"></div>
                        <div class="toggle-label">Recording</div>
                    </div>
                    <div class="toggle-item" data-option="intense_recording" id="intense-recording-toggle" style="display: none;">
                        <div class="toggle-icon"></div>
                        <div class="toggle-label">Intense Recording</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <div class="section-header">
                    <span class="section-icon"></span>
                    <span class="section-title">Packing Strategy</span>
                </div>

                <div class="form-group">
                    <select class="strategy-select" id="strategy-select" onchange="updateAiOptions()">
                        <option value="base"> Base Strategy (Rule-based)</option>
                        <option value="llm"> AI Strategy (Claude)</option>
                    </select>
                    <p class="form-label" style="margin-top: 8px; font-size: 0.8rem;">
                        Base uses proven rules. AI generates custom suggestions.
                    </p>
                </div>

                <div id="ai-options" style="display: none; margin-top: 16px;">
                    <div class="form-group">
                        <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <label class="form-label">Precision Level</label>
                                <select class="strategy-select" id="precision-select">
                                    <option value="low"> Low (fastest)</option>
                                    <option value="medium"> Medium</option>
                                    <option value="high"> High</option>
                                    <option value="really-high" selected> Really High</option>
                                </select>
                            </div>
                            <div style="flex: 0 0 auto; display: flex; align-items: flex-end;">
                                <div class="toggle-item" id="sensitive-toggle" data-option="sensitive" style="margin: 0; padding: 10px 16px;">
                                    <div class="toggle-icon"></div>
                                    <div class="toggle-label">Sensitive</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <label class="form-label" style="margin: 0;">AI Prompt (editable)</label>
                            <div class="prompt-actions">
                                <button type="button" class="prompt-btn" onclick="openPromptManager()"> Load</button>
                                <button type="button" class="prompt-btn" onclick="saveCurrentPrompt()"> Save</button>
                                <button type="button" class="prompt-btn" onclick="refreshPromptPreview()"> Refresh</button>
                            </div>
                        </div>
                        <textarea id="prompt-editor" class="prompt-editor" rows="12" placeholder="Select trip options above, then the prompt will appear here..."></textarea>
                    </div>
                </div>
            </div>

            <button class="btn-generate" onclick="generateList()">Generate Packing List</button>
        </div>

        <div id="results" class="fade-in">
            <div class="trip-bar">
                <div class="app-title">
                    <span></span> BagBuddy
                </div>
                <div class="trip-info">
                    <span class="trip-name" id="trip-name-display" onclick="startEditTripName()"></span>
                    <input type="text" class="trip-name-edit" id="trip-name-edit" onblur="saveTripName()" onkeydown="if(event.key==='Enter')this.blur()">
                    <span class="save-status" id="save-status">
                        <span id="save-icon"></span>
                        <span id="save-text"></span>
                    </span>
                </div>
                <div class="trip-actions">
                    <button class="trip-btn icon-only" id="undo-btn" onclick="undoAction()" title="Undo"></button>
                    <button class="trip-btn icon-only" id="redo-btn" onclick="redoAction()" title="Redo"></button>
                    <button class="trip-btn desktop-only" onclick="savePreparation()"> Save Prep</button>
                    <button class="trip-btn" onclick="newTrip()">+</button>
                </div>
            </div>

            <div class="section">
                <div class="results-layout">
                    <div class="left-column">
                        <div id="packing-list"></div>

                        <div class="add-item-section">
                            <button class="add-category-btn" onclick="openAddCategoryModal()">+ Add Category</button>
                        </div>
                    </div>

                    <div class="resize-handle" id="resize-handle"></div>

                    <div class="right-column" id="right-column">
                        <div class="cubes-section">
                            <div class="cubes-header">
                                <span class="cubes-title">Bags</span>
                        <div class="cubes-actions">
                            <div class="search-container">
                                <input type="text" class="search-input" id="item-search" placeholder=" Find..." oninput="searchItem(this.value)" onfocus="searchItem(this.value)" autocomplete="off">
                                <div class="search-autocomplete" id="search-autocomplete" style="display: none;"></div>
                            </div>
                            <button class="add-cube-btn" onclick="openEmojiPicker()">+ Bag</button>
                            <button class="add-cube-btn mobile-hide" id="create-from-selection-btn" onclick="createBagFromSelection()" title="Create bag from selected items"> From Selection</button>
                            <button class="add-cube-btn mobile-hide" id="estimate-weights-btn" onclick="estimateWeights()" title="Estimate item weights with AI"> Weights</button>
                            <button class="summary-btn mobile-hide" onclick="generatePackingSummary()"> Summary</button>
                            <button class="add-cube-btn mobile-hide" onclick="printChecklist()" title="Print packing checklist"> Print</button>
                            <div class="drop-zone trash mobile-hide" id="trash-zone">
                                <span class="drop-zone-icon"></span>
                            </div>
                        </div>
                            </div>
                            <div class="cubes-grid" id="cubes-grid"></div>
                            <div class="packing-summary" id="packing-summary" style="display: none;">
                                <div class="summary-header">
                                    <span> Packing Summary</span>
                                    <button class="summary-close" onclick="closeSummary()">&times;</button>
                                </div>
                                <div class="summary-content" id="summary-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floating Action Buttons -->
            <div class="fab-container" id="fab-container">
                <button class="fab progress-fab" onclick="openProgressPopup()">
                    <span id="progress-percent">0%</span>
                    <span class="fab-label">Progress</span>
                </button>
                <button class="fab ai-fab" id="ai-fab" style="display: none;" onclick="openAiPopup()">
                    
                    <span class="fab-label">Ask AI</span>
                </button>
                <button class="fab todoist-fab" onclick="openTodoistPopup()">
                    
                    <span class="fab-label">Save to Todoist</span>
                </button>
                <button class="fab more-fab" onclick="openMobileMenu()">
                    
                    <span class="fab-label">More</span>
                </button>
            </div>
            <!-- Mobile theme toggle (bottom left) -->
            <button class="mobile-theme-toggle" id="mobile-theme-toggle" onclick="toggleTheme()"></button>

            <!-- Mobile More Menu -->
            <div class="mobile-menu-overlay" id="mobile-menu-overlay" onclick="closeMobileMenu()">
                <div class="mobile-menu" onclick="event.stopPropagation()">
                    <button onclick="createBagFromSelection(); closeMobileMenu();"> Bag from Selection</button>
                    <button onclick="estimateWeights(); closeMobileMenu();"> Estimate Weights</button>
                    <button onclick="generatePackingSummary(); closeMobileMenu();"> Packing Summary</button>
                    <button onclick="printChecklist(); closeMobileMenu();"> Print Checklist</button>
                    <button onclick="savePreparation(); closeMobileMenu();"> Save as Prep</button>
                    <button onclick="closeMobileMenu();" class="cancel-btn">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Progress Popup -->
        <div class="popup-overlay" id="progress-popup" onclick="closePopupOnOverlay(event, 'progress-popup')">
            <div class="popup">
                <div class="popup-header">
                    <span class="popup-title"> Packing Progress</span>
                    <button class="popup-close" onclick="closePopup('progress-popup')">&times;</button>
                </div>
                <div class="progress-bar" style="height: 20px; margin-bottom: 16px;">
                    <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progress-text" style="text-align: center; font-size: 1.1rem;">0 items left to pack</div>
            </div>
        </div>

        <!-- AI Popup -->
        <div class="popup-overlay" id="ai-popup" onclick="closePopupOnOverlay(event, 'ai-popup')">
            <div class="popup">
                <div class="popup-header">
                    <span class="popup-title"> Ask AI</span>
                    <button class="popup-close" onclick="closePopup('ai-popup')">&times;</button>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 12px;">Tell the AI what to do with your packing list</p>
                <div class="ai-action-row">
                    <input type="text" class="ai-action-input" id="ai-action-input"
                           placeholder="e.g., Create 3 packing cubes, I packed my chargers...">
                    <button class="ai-action-btn" id="ai-action-btn" onclick="sendAiAction()">Send</button>
                </div>
            </div>
        </div>

        <!-- Todoist Popup -->
        <div class="popup-overlay" id="todoist-popup" onclick="closePopupOnOverlay(event, 'todoist-popup')">
            <div class="popup">
                <div class="popup-header">
                    <span class="popup-title"> Save to Todoist</span>
                    <button class="popup-close" onclick="closePopup('todoist-popup')">&times;</button>
                </div>
                <div class="save-section" style="margin: 0; padding: 0; background: none; border: none;">
                    <input type="text" class="input-text" id="list-name" placeholder="Packing list name (e.g., NYC Trip December)">
                    <button class="btn-save" onclick="saveToTodoist()" style="width: 100%;">
                        <span></span> Save to Todoist
                    </button>
                    <div id="status-message" class="status-message"></div>
                </div>
            </div>
        </div>

        <!-- Modal for viewing bag contents -->
        <div class="modal-overlay" id="bag-modal">
            <div class="modal">
                <div class="modal-header">
                    <span class="modal-title" id="modal-title"> Suitcase</span>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-items" id="modal-items"></div>
                <div class="modal-add-section">
                    <input type="text" class="modal-add-input" id="modal-add-input" placeholder="Add item to this bag...">
                    <button class="modal-add-btn" onclick="addItemToCurrentBag()">+</button>
                </div>
            </div>
        </div>

        <!-- Weight Edit Modal -->
        <div class="modal-overlay" id="weight-modal" onclick="closeWeightModalOnOverlay(event)">
            <div class="modal" style="max-width: 320px;">
                <div class="modal-header">
                    <span class="modal-title"> <span id="weight-modal-item-name">Item</span></span>
                    <button class="modal-close" onclick="closeWeightModal()">&times;</button>
                </div>
                <div class="weight-modal-content">
                    <div style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px;">Weight per single item:</div>
                    <div class="weight-input-group">
                        <input type="number" id="weight-input" class="weight-input" placeholder="e.g. 150" min="0">
                        <span class="weight-unit">grams</span>
                    </div>
                    <div class="weight-modal-actions">
                        <button class="weight-btn weight-btn-estimate" onclick="estimateWeightFromModal()">
                             Auto-estimate
                        </button>
                        <button class="weight-btn weight-btn-save" onclick="saveWeightFromModal()">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rename Item Modal -->
        <div class="modal-overlay" id="rename-modal" onclick="closeRenameModalOnOverlay(event)">
            <div class="modal" style="max-width: 320px;">
                <div class="modal-header">
                    <span class="modal-title"> Rename Item</span>
                    <button class="modal-close" onclick="closeRenameModal()">&times;</button>
                </div>
                <div class="weight-modal-content">
                    <div class="weight-input-group">
                        <input type="text" id="rename-input" class="weight-input" placeholder="New name" style="width: 100%;">
                    </div>
                    <div class="weight-modal-actions">
                        <button class="weight-btn weight-btn-save" onclick="saveRenameFromModal()">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Prompt Manager Popup -->
        <div class="popup-overlay" id="prompt-manager" onclick="closePopupOnOverlay(event, 'prompt-manager')">
            <div class="popup" style="max-width: 600px;">
                <div class="popup-header">
                    <span class="popup-title"> Saved Prompts</span>
                    <button class="popup-close" onclick="closePopup('prompt-manager')">&times;</button>
                </div>
                <div class="prompt-list" id="prompt-list">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">No saved prompts yet</p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="prompt-btn" style="flex: 1;" onclick="loadSelectedPrompt()">Load Selected</button>
                    <button class="prompt-btn" onclick="closePopup('prompt-manager')">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Preparation Manager Popup -->
        <div class="popup-overlay" id="preparation-manager" onclick="closePopupOnOverlay(event, 'preparation-manager')">
            <div class="popup" style="max-width: 600px;">
                <div class="popup-header">
                    <span class="popup-title"> Saved Preparations</span>
                    <button class="popup-close" onclick="closePopup('preparation-manager')">&times;</button>
                </div>
                <div class="prompt-list" id="preparation-list">
                    <p style="color: var(--text-muted); text-align: center; padding: 20px;">No saved preparations yet</p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="prompt-btn" style="flex: 1;" onclick="loadSelectedPreparation()">Load Selected</button>
                    <button class="prompt-btn" onclick="closePopup('preparation-manager')">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Save Prompt Popup -->
        <div class="popup-overlay" id="save-prompt-popup" onclick="closePopupOnOverlay(event, 'save-prompt-popup')">
            <div class="popup">
                <div class="popup-header">
                    <span class="popup-title"> Save Prompt</span>
                    <button class="popup-close" onclick="closePopup('save-prompt-popup')">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Prompt Name</label>
                    <input type="text" class="input-text" id="prompt-name-input" placeholder="e.g., Winter Trip Template">
                </div>
                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="prompt-btn" style="flex: 1; background: var(--accent-primary); color: white; border-color: var(--accent-primary);" onclick="confirmSavePrompt()">Save</button>
                    <button class="prompt-btn" onclick="closePopup('save-prompt-popup')">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Add Category Modal -->
        <div class="popup-overlay" id="add-category-modal" onclick="closePopupOnOverlay(event, 'add-category-modal')">
            <div class="popup">
                <div class="popup-header">
                    <span class="popup-title"> Add Category</span>
                    <button class="popup-close" onclick="closePopup('add-category-modal')">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Category Name</label>
                    <input type="text" class="input-text" id="new-category-name" placeholder="e.g., Beach Gear">
                </div>
                <div class="form-group">
                    <label class="form-label">Icon (emoji)</label>
                    <input type="text" class="input-text" id="new-category-icon" placeholder="e.g., " style="width: 60px;">
                </div>
                <div style="display: flex; gap: 8px; margin-top: 16px;">
                    <button class="prompt-btn" style="flex: 1; background: var(--accent-primary); color: white; border-color: var(--accent-primary);" onclick="addNewCategory()">Add Category</button>
                    <button class="prompt-btn" onclick="closePopup('add-category-modal')">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Generation Progress Overlay -->
        <div class="generation-overlay" id="generation-overlay">
            <div class="generation-content">
                <div class="generation-spinner"></div>
                <div class="generation-title">Generating your packing list...</div>
                <div class="generation-subtitle" id="generation-model">Using AI to create the perfect list</div>
                <div class="generation-progress-bar">
                    <div class="generation-progress-fill" id="generation-progress-fill" style="width: 0%"></div>
                </div>
                <div class="generation-time" id="generation-time">Estimated: ~10s</div>
            </div>
        </div>

        <!-- Emoji Picker for Packing Cubes -->
        <div class="emoji-picker-overlay" id="emoji-picker">
            <div class="emoji-picker">
                <div class="emoji-picker-title">Create Packing Cube</div>
                <div class="emoji-grid" id="emoji-grid"></div>
                <input type="text" class="cube-name-input" id="cube-name-input" placeholder="Cube name (e.g., Toiletries)">
                <div class="emoji-picker-actions">
                    <button class="btn-cancel-cube" onclick="closeEmojiPicker()">Cancel</button>
                    <button class="btn-create-cube" onclick="createCube()">Create</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // BagBuddy - Client-side packing app
        const PROXY_URL = 'https://trip-planner-proxy.l-charignon.workers.dev';
        let apiKey = localStorage.getItem('openai_api_key');
        
        // Check if logged in
        if (!apiKey) {
            document.addEventListener('DOMContentLoaded', () => {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('main-app').style.display = 'none';
            });
        }
        
        async function validateAndSaveKey(key) {
            if (!key || !key.trim()) {
                alert('Please enter an API key');
                return false;
            }
            try {
                // Validate with a minimal chat completion request
                const resp = await fetch(PROXY_URL + '/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{ role: 'user', content: 'hi' }],
                        max_tokens: 1
                    })
                });
                const data = await resp.json();
                if (data.error) throw new Error(data.error.message || 'Invalid key');
                apiKey = key;
                localStorage.setItem('openai_api_key', key);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                return true;
            } catch(e) {
                alert('Invalid API key: ' + e.message);
                return false;
            }
        }
        
        function logout() {
            if (!confirm('Logout and clear API key?')) return;
            localStorage.removeItem('openai_api_key');
            apiKey = null;
            location.reload();
        }
        
        // LocalStorage functions for trips
        function getTrips() { return JSON.parse(localStorage.getItem('bagbuddy_trips') || '{}'); }
        function saveTripsData(trips) { localStorage.setItem('bagbuddy_trips', JSON.stringify(trips)); }
        function getTripById(id) { return getTrips()[id]; }
        function saveTripById(id, data) { const trips = getTrips(); trips[id] = {...data, updatedAt: new Date().toISOString()}; saveTripsData(trips); }
        function deleteTripById(id) { const trips = getTrips(); delete trips[id]; saveTripsData(trips); }
        
        // LocalStorage for preparations
        function getPreparations() { return JSON.parse(localStorage.getItem('bagbuddy_preparations') || '[]'); }
        function savePreparations(preps) { localStorage.setItem('bagbuddy_preparations', JSON.stringify(preps)); }

        // Import/Export functions
        function importTripFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const tripId = file.name.replace('.json', '').replace(/[^a-z0-9-]/gi, '-').toLowerCase();
                    importTripData(tripId, data);
                } catch (err) {
                    alert('Invalid JSON file: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset for re-import
        }

        function importTripData(tripId, data) {
            // Ensure unique ID
            let finalId = tripId;
            const existing = getTrips();
            let counter = 1;
            while (existing[finalId]) {
                finalId = tripId + '-' + counter++;
            }
            saveTripById(finalId, data);
            loadTrips();
            alert(`Trip imported as "${finalId}"`);
        }

        function exportAllTrips() {
            const trips = getTrips();
            const blob = new Blob([JSON.stringify(trips, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bagbuddy-trips-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportCurrentTrip() {
            if (!currentTripId) return;
            const data = getTripById(currentTripId);
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentTripId + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // LocalStorage for prompts
        function getPrompts() { return JSON.parse(localStorage.getItem('bagbuddy_prompts') || '[]'); }
        function savePromptsData(prompts) { localStorage.setItem('bagbuddy_prompts', JSON.stringify(prompts)); }

        // OpenAI API helper for weight estimation
        async function estimateWeightViaAI(itemName, category) {
            const prompt = `Estimate the weight in grams for this packing item: "${itemName}" (category: ${category}).
Reply with ONLY a number representing the weight in grams. No units, no explanation, just the number.
For example, if it's a toothbrush, reply: 30`;

            const resp = await fetch(PROXY_URL + '/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 50
                })
            });
            const data = await resp.json();
            if (data.error) throw new Error(data.error.message || 'API error');
            const content = data.choices[0].message.content.trim();
            const weight = parseInt(content.replace(/[^\d]/g, ''), 10);
            if (isNaN(weight)) throw new Error('Could not parse weight');
            return weight;
        }

        // OpenAI API helper for bulk weight estimation
        async function estimateWeightsViaAI(items) {
            const itemList = items.map(i => `- ${i.name} (${i.category})`).join('\n');
            const prompt = `Estimate the weight in grams for each of these packing items:
${itemList}

Reply with a JSON object where keys are the exact item names and values are weights in grams.
Example: {"toothbrush": 30, "laptop": 1500}`;

            const resp = await fetch(PROXY_URL + '/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                body: JSON.stringify({
                    model: 'gpt-4o-mini',
                    messages: [{ role: 'user', content: prompt }],
                    max_tokens: 2000
                })
            });
            const data = await resp.json();
            if (data.error) throw new Error(data.error.message || 'API error');
            const content = data.choices[0].message.content.trim();
            // Extract JSON from response (might be wrapped in markdown code blocks)
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (!jsonMatch) throw new Error('Could not parse weights');
            return JSON.parse(jsonMatch[0]);
        }

        // Mobile detection and DOM manipulation
        (function() {
            const isMobile = window.innerWidth <= 500 ||
                             ('ontouchstart' in window) ||
                             (navigator.maxTouchPoints > 0);

            if (isMobile) {
                document.body.classList.add('is-mobile');

                // Wait for DOM then apply mobile layout
                document.addEventListener('DOMContentLoaded', applyMobileLayout);
                if (document.readyState !== 'loading') {
                    applyMobileLayout();
                }
            }

            function applyMobileLayout() {
                // FORCE HIDE elements
                const hideSelectors = [
                    '.app-title',
                    '.trip-name-edit',
                    '.desktop-only',
                    '#create-from-selection-btn',
                    '#estimate-weights-btn',
                    '.summary-btn',
                    '[onclick*="printChecklist"]',
                    '[onclick*="savePreparation"]',
                    '#trash-zone',
                    '.drop-zones',
                    '.sticky-header',
                    '.theme-toggle',
                    '#save-text',
                    '.mobile-menu-overlay',
                    '.cubes-title',
                    '.cubes-header'
                ];

                hideSelectors.forEach(sel => {
                    document.querySelectorAll(sel).forEach(el => {
                        el.style.display = 'none';
                    });
                });

                // Container - no padding
                const container = document.querySelector('.container.wide');
                if (container) {
                    container.style.cssText = 'padding:4px!important;max-width:100%;';
                }

                // Results section - no box
                const resultsSection = document.querySelector('#results > .section');
                if (resultsSection) {
                    resultsSection.style.cssText = 'padding:0;margin:0;border:none;box-shadow:none;background:transparent;';
                }

                // Style trip bar - minimal
                const tripBar = document.querySelector('.trip-bar');
                if (tripBar) {
                    tripBar.style.cssText = 'padding:2px 4px;margin:0;border:none;gap:6px;';
                }

                // Style trip name - bigger
                const tripName = document.querySelector('.trip-name');
                if (tripName) {
                    tripName.style.cssText = 'font-size:1.1rem;font-weight:700;';
                }

                // Style save status - just icon
                const saveStatus = document.querySelector('.save-status');
                if (saveStatus) {
                    saveStatus.style.cssText = 'font-size:0.9rem;';
                }

                // Trip buttons - compact
                document.querySelectorAll('.trip-btn').forEach(btn => {
                    btn.style.cssText = 'padding:4px 8px;font-size:0.9rem;border:1px solid var(--border-color);';
                });

                // Results layout - vertical stack
                const resultsLayout = document.querySelector('.results-layout');
                if (resultsLayout) {
                    resultsLayout.style.cssText = 'display:flex;flex-direction:column;gap:4px;';
                }

                // LEFT COLUMN - items - take most space, no box styling
                const leftCol = document.querySelector('.left-column');
                if (leftCol) {
                    leftCol.style.cssText = 'flex:1;min-height:50vh;padding:4px;overflow-y:auto;background:transparent;border-radius:0;';
                }

                // RIGHT COLUMN - bags - more space at bottom
                const rightCol = document.querySelector('.right-column');
                if (rightCol) {
                    rightCol.style.cssText = 'max-height:40vh;overflow-y:auto;padding:0;';
                }

                // Cubes section - no box, minimal
                const cubesSection = document.querySelector('.cubes-section');
                if (cubesSection) {
                    cubesSection.style.cssText = 'padding:4px;background:transparent;border:none;';
                }

                // Cubes actions - inline with bags
                const cubesActions = document.querySelector('.cubes-actions');
                if (cubesActions) {
                    cubesActions.style.cssText = 'display:flex;gap:4px;margin-bottom:4px;';
                }

                // Search input - compact
                const searchInput = document.querySelector('.search-input');
                if (searchInput) {
                    searchInput.style.cssText = 'width:60px;padding:3px 6px;font-size:0.7rem;';
                }

                // Add bag button - compact
                document.querySelectorAll('.add-cube-btn').forEach(btn => {
                    if (btn.style.display !== 'none') {
                        btn.style.cssText = 'padding:3px 6px;font-size:0.7rem;';
                    }
                });

                // Cubes grid - horizontal scroll
                const cubesGrid = document.querySelector('.cubes-grid');
                if (cubesGrid) {
                    cubesGrid.style.cssText = 'display:flex;flex-wrap:wrap;gap:4px;padding:0;justify-content:flex-start;';
                }

                // All packing cubes - small
                document.querySelectorAll('.packing-cube').forEach(cube => {
                    cube.style.cssText = 'width:55px!important;height:55px!important;min-width:55px!important;min-height:55px!important;padding:3px!important;border-radius:8px;';
                });

                document.querySelectorAll('.cube-icon').forEach(icon => {
                    icon.style.fontSize = '14px';
                });

                document.querySelectorAll('.cube-name').forEach(name => {
                    name.style.cssText = 'font-size:0.5rem;line-height:1;';
                });

                // Categories - no box
                document.querySelectorAll('.category').forEach(cat => {
                    cat.style.cssText = 'margin-bottom:8px;';
                });

                document.querySelectorAll('.category-header').forEach(hdr => {
                    hdr.style.cssText = 'padding:0 0 4px 0;margin-bottom:4px;gap:4px;';
                });

                document.querySelectorAll('.category-name').forEach(name => {
                    name.style.cssText = 'font-size:0.85rem;font-weight:600;';
                });

                document.querySelectorAll('.category-icon').forEach(icon => {
                    icon.style.fontSize = '12px';
                });

                // Items - compact, no extra styling
                document.querySelectorAll('.item-list').forEach(list => {
                    list.style.cssText = 'gap:3px;';
                });

                document.querySelectorAll('.item').forEach(item => {
                    item.style.cssText = 'padding:6px 8px;font-size:0.85rem;min-height:32px;border-radius:4px;';
                });

                document.querySelectorAll('.item-count').forEach(cnt => {
                    cnt.style.cssText = 'padding:1px 4px;font-size:0.7rem;';
                });

                document.querySelectorAll('.item-weight').forEach(wt => {
                    wt.style.cssText = 'padding:1px 4px;font-size:0.65rem;';
                });

                // FABs - bottom right, above safari bar
                const fabContainer = document.querySelector('.fab-container');
                if (fabContainer) {
                    fabContainer.style.cssText = 'position:fixed;bottom:50px;right:6px;flex-direction:column;gap:4px;';
                }

                document.querySelectorAll('.fab').forEach(fab => {
                    fab.style.cssText += 'width:32px!important;height:32px!important;font-size:11px!important;border-radius:16px;';
                });

                // Hide todoist, show more
                const todoistFab = document.querySelector('.todoist-fab');
                if (todoistFab) todoistFab.style.display = 'none';

                const moreFab = document.querySelector('.more-fab');
                if (moreFab) moreFab.style.display = 'flex';

                // Mobile theme toggle - bottom left
                const mobileTheme = document.querySelector('.mobile-theme-toggle');
                if (mobileTheme) {
                    mobileTheme.style.cssText = 'display:flex!important;position:fixed;bottom:50px;left:6px;width:32px;height:32px;border-radius:16px;border:none;background:var(--bg-secondary);font-size:14px;align-items:center;justify-content:center;z-index:100;box-shadow:0 2px 6px rgba(0,0,0,0.2);';
                }

                // Add item button - smaller
                document.querySelectorAll('.add-item-inline').forEach(btn => {
                    btn.style.cssText = 'width:24px;height:24px;font-size:0.8rem;';
                });
            }

            // Re-apply on resize
            window.addEventListener('resize', function() {
                if (window.innerWidth <= 500) {
                    document.body.classList.add('is-mobile');
                    applyMobileLayout();
                } else {
                    document.body.classList.remove('is-mobile');
                }
            });
        })();

        let days = 2;
        let currentList = null;
        let itemStates = {}; // {itemId: {packed, bag, cube, name, count, category}}
        let suitcaseItems = [];
        let backpackItems = [];
        let customItems = [];
        let itemIdCounter = 0;
        let currentTripId = null;
        let saveTimeout = null;
        let selectedItems = [];
        let savedPreparations = [];
        let selectedPreparationId = null;
        let allDestinations = [];

        // Undo/redo
        let undoStack = [];
        let redoStack = [];
        let historySuspended = false;
        const HISTORY_LIMIT = 20;

        // Packing cubes
        let packingCubes = {}; // {cubeId: {emoji, name, parentBag, items[], children: []}}
        let cubeIdCounter = 0;
        let selectedEmoji = null;
        let currentOpenBag = null; // Track currently open bag/cube for adding items
        let currentOpenBagType = null; // 'suitcase', 'backpack', or 'cube'

        // Mobile menu functions
        function openMobileMenu() {
            document.getElementById('mobile-menu-overlay').classList.add('active');
        }

        function closeMobileMenu() {
            document.getElementById('mobile-menu-overlay').classList.remove('active');
        }

        // Trip name inline editing
        function startEditTripName() {
            if (!document.body.classList.contains('is-mobile')) return; // Only on mobile
            const display = document.getElementById('trip-name-display');
            const input = document.getElementById('trip-name-edit');
            input.value = display.textContent;
            display.style.display = 'none';
            input.style.display = 'block';
            input.focus();
            input.select();
        }

        function saveTripName() {
            const display = document.getElementById('trip-name-display');
            const input = document.getElementById('trip-name-edit');
            // For now, just restore display (trip names are generated, not editable)
            display.style.display = '';
            input.style.display = 'none';
        }

        // Update mobile theme toggle icon
        function updateMobileThemeToggle() {
            const toggle = document.getElementById('mobile-theme-toggle');
            if (toggle) {
                toggle.textContent = document.documentElement.getAttribute('data-theme') === 'dark' ? '' : '';
            }
        }

        // Trips browser
        function toggleTripsBrowser() {
            const browser = document.getElementById('trips-browser');
            browser.classList.toggle('expanded');
            if (browser.classList.contains('expanded')) {
                loadTrips();
            }
        }

        function loadTrips() {
            const includeArchived = document.getElementById('show-archived')?.checked || false;
            const listEl = document.getElementById('trips-list');
            const countEl = document.getElementById('trips-count');

            try {
                const allTrips = getTrips();
                let trips = Object.entries(allTrips).map(([id, data]) => ({
                    id, ...data,
                    modified_at: data.updatedAt ? new Date(data.updatedAt).toLocaleDateString() : ''
                }));
                if (!includeArchived) trips = trips.filter(t => !t.archived);
                trips.sort((a, b) => new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0));

                countEl.textContent = `(${trips.length})`;

                if (trips.length === 0) {
                    listEl.innerHTML = '<div class="trips-empty">No trips yet. Create one above!</div>';
                    return;
                }

                listEl.innerHTML = trips.map(trip => {
                    const tripTypeLabel = {
                        'solo_day': 'Solo Day',
                        'solo_multi': 'Solo Multi-Day',
                        'family_multi': 'Family'
                    }[trip.trip_type] || trip.trip_type || 'Unknown';

                    const daysLabel = trip.days ? `${trip.days} day${trip.days > 1 ? 's' : ''}` : '';
                    const destLabel = trip.destination || 'Unknown';
                    const meta = [destLabel, tripTypeLabel, daysLabel, trip.modified_at].filter(Boolean).join('  ');

                    const archiveBadge = trip.archived ? '<span class="archived-badge">Archived</span>' : '';
                    const archiveBtn = trip.archived
                        ? `<button class="trip-item-btn" onclick="unarchiveTripItem('${trip.id}')">Restore</button>`
                        : `<button class="trip-item-btn" onclick="archiveTripItem('${trip.id}')">Archive</button>`;

                    return `
                        <div class="trip-item ${trip.archived ? 'archived' : ''}">
                            <div class="trip-item-info">
                                <div class="trip-item-name">
                                    ${trip.id}
                                    ${archiveBadge}
                                </div>
                                <div class="trip-item-meta">${meta}</div>
                            </div>
                            <div class="trip-item-actions">
                                <button class="trip-item-btn primary" onclick="openTrip('${trip.id}')">Open</button>
                                ${archiveBtn}
                                <button class="trip-item-btn danger" onclick="deleteTripItem('${trip.id}')">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                listEl.innerHTML = '<div class="trips-empty">Failed to load trips</div>';
                console.error('Failed to load trips:', err);
            }
        }

        function openTrip(tripId) {
            const tripData = getTripById(tripId);
            if (tripData) {
                loadTripState(tripId, tripData, true);
            } else {
                alert('Trip not found');
            }
        }

        function archiveTripItem(tripId) {
            if (!confirm(`Archive trip "${tripId}"?`)) return;
            const trips = getTrips();
            if (trips[tripId]) {
                trips[tripId].archived = true;
                saveTripsData(trips);
                loadTrips();
            }
        }

        function unarchiveTripItem(tripId) {
            const trips = getTrips();
            if (trips[tripId]) {
                trips[tripId].archived = false;
                saveTripsData(trips);
                loadTrips();
            }
        }

        function deleteTripItem(tripId) {
            const confirmation = prompt(`Type "delete" to permanently delete trip "${tripId}". This cannot be undone.`);
            if (confirmation !== 'delete') {
                if (confirmation !== null) alert('Deletion cancelled - you must type "delete" to confirm.');
                return;
            }
            deleteTripById(tripId);
            loadTrips();
        }

        // Destination autocomplete - get from existing trips
        function loadDestinations() {
            try {
                const trips = getTrips();
                allDestinations = [...new Set(Object.values(trips).map(t => t.destination).filter(Boolean))];
            } catch (err) {
                console.error('Failed to load destinations:', err);
                allDestinations = [];
            }
        }

        function showDestinationSuggestions() {
            const input = document.getElementById('destination-input');
            filterDestinations(input.value);
        }

        function filterDestinations(query) {
            const autocomplete = document.getElementById('destination-autocomplete');
            const lowerQuery = query.toLowerCase();

            let suggestions = allDestinations;
            if (query.length > 0) {
                suggestions = allDestinations.filter(d => d.toLowerCase().includes(lowerQuery));
            }

            if (suggestions.length === 0 && query.length === 0) {
                autocomplete.style.display = 'none';
                return;
            }

            if (suggestions.length === 0) {
                autocomplete.innerHTML = '<div class="destination-suggestion" style="color: var(--text-muted);">No previous destinations match</div>';
            } else {
                autocomplete.innerHTML = suggestions.slice(0, 8).map(d => `
                    <div class="destination-suggestion" onclick="selectDestination('${d.replace(/'/g, "\\'")}')">${d}</div>
                `).join('');
            }
            autocomplete.style.display = 'block';
        }

        function selectDestination(dest) {
            document.getElementById('destination-input').value = dest;
            document.getElementById('destination-autocomplete').style.display = 'none';
            scheduleSave();
        }

        function getDestination() {
            return document.getElementById('destination-input')?.value?.trim() || '';
        }

        // Close destination autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            const autocomplete = document.getElementById('destination-autocomplete');
            const container = document.querySelector('.destination-container');
            if (autocomplete && container && !container.contains(e.target)) {
                autocomplete.style.display = 'none';
            }
        });

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.getElementById('theme-icon').textContent = newTheme === 'dark' ? '' : '';
            updateMobileThemeToggle();
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '' : '';
            updateMobileThemeToggle();
        }

        // Auto-save trip state
        function scheduleSave() {
            if (!currentTripId) return;
            if (saveTimeout) clearTimeout(saveTimeout);
            updateSaveStatus('saving');
            saveTimeout = setTimeout(() => {
                saveTripState();
            }, 500);
        }

        function saveTripState() {
            if (!currentTripId || !currentList) return null;
            const tripData = {
                packing_list: currentList,
                days: days,
                trip_type: getTripType(),
                destination: getDestination(),
                options: getOptions(),
                item_states: itemStates,
                suitcase_items: suitcaseItems,
                backpack_items: backpackItems,
                custom_items: customItems,
                packing_cubes: packingCubes,
                item_id_counter: itemIdCounter,
                cube_id_counter: cubeIdCounter,
                category_icons: categoryIcons
            };
            try {
                saveTripById(currentTripId, tripData);
                updateSaveStatus('saved');
                return tripData;
            } catch (e) {
                console.error('Save error:', e);
                updateSaveStatus('error');
                throw e;
            }
        }

        function updateSaveStatus(status) {
            const statusEl = document.getElementById('save-status');
            const iconEl = document.getElementById('save-icon');
            const textEl = document.getElementById('save-text');
            statusEl.className = 'save-status ' + status;
            if (status === 'saving') {
                iconEl.textContent = '';
                textEl.textContent = 'Saving...';
            } else if (status === 'saved') {
                iconEl.textContent = '';
                textEl.textContent = 'Saved';
            } else if (status === 'error') {
                iconEl.textContent = '';
                textEl.textContent = 'Save failed';
            }
        }

        function updateTripDisplay() {
            document.getElementById('trip-name-display').textContent = currentTripId || '';
        }

        function newTrip() {
            if (!confirm('Start a new trip? Your current trip is saved.')) return;
            // Reset state
            currentTripId = null;
            currentList = null;
            itemStates = {};
            packingCubes = {};
            suitcaseItems = [];
            backpackItems = [];
            customItems = [];
            itemIdCounter = 0;
            cubeIdCounter = 0;
            categoryIcons = { ...defaultCategoryIcons };
            selectedItems = [];
            undoStack = [];
            redoStack = [];
            normalizeCubes();
            // Show form, hide results
            document.getElementById('results').classList.remove('active');
            document.getElementById('form-section').style.display = 'block';
            document.querySelector('.container').classList.remove('wide');
            document.body.classList.remove('no-scroll');
            window.history.pushState({}, '', '/');
        }


        async function savePreparation() {
            if (!currentTripId) return;
            const name = window.prompt('Name this preparation so you can reuse it later:', currentTripId);
            if (name === null) return;
            try {
                await saveTripState();
                const tripData = getTripById(currentTripId);
                const preps = getPreparations();
                const prep = {
                    id: 'prep-' + Date.now(),
                    name: name.trim() || currentTripId,
                    trip_id: currentTripId,
                    created: new Date().toISOString().split('T')[0],
                    data: tripData
                };
                preps.push(prep);
                savePreparations(preps);
                alert(`Saved as "${prep.name}". Open Saved Preparations to start from it next time.`);
            } catch (e) {
                console.error('Save preparation error:', e);
                alert('Could not save this preparation. Please try again.');
            }
        }

        function getOptions() {
            const options = {};
            document.querySelectorAll('.toggle-item').forEach(item => {
                options[item.dataset.option] = item.classList.contains('active');
            });
            return options;
        }

        function loadTripFromUrl() {
            // For client-side only: check URL hash or localStorage for last trip
            const hash = window.location.hash.substring(1);
            if (hash) {
                const tripData = getTripById(hash);
                if (tripData) {
                    loadTripState(hash, tripData, false);
                    return;
                }
            }
            // Otherwise just show the trip list
            loadTrips();
        }

        function loadTripState(tripId, data, pushHistory = false) {
            currentTripId = tripId;
            currentList = data.packing_list;
            days = data.days || 2;
            itemStates = data.item_states || {};
            suitcaseItems = data.suitcase_items || [];
            backpackItems = data.backpack_items || [];
            customItems = data.custom_items || [];
            packingCubes = data.packing_cubes || {};
            itemIdCounter = data.item_id_counter || 0;
            cubeIdCounter = data.cube_id_counter || 0;
            categoryIcons = { ...defaultCategoryIcons, ...(data.category_icons || {}) };
            selectedItems = [];
            undoStack = [];
            redoStack = [];

            // Load destination
            const destInput = document.getElementById('destination-input');
            if (destInput) {
                destInput.value = data.destination || '';
            }

            // Ensure default bags exist
            normalizeCubes();

            // Update trip display
            updateTripDisplay();

            // Show results - render list first to create itemStates
            renderPackingList(currentList);

            // If bags exist from LLM but packing_cubes is mostly empty, apply them
            const hasLLMBags = data.bags && data.bags.length > 0;
            const cubesAreEmpty = Object.keys(packingCubes).every(id =>
                packingCubes[id].items.length === 0
            );
            if (hasLLMBags && cubesAreEmpty) {
                console.log('Migrating LLM bags to packing cubes...');
                applyBagsFromLLM(data.bags);
                // Re-render to hide packed items
                renderPackingList(currentList);
            }

            renderCubes();
            document.getElementById('form-section').style.display = 'none';
            document.getElementById('results').classList.add('active');
            document.querySelector('.container').classList.add('wide');
            document.body.classList.add('no-scroll');
            if (pushHistory && tripId) {
                window.history.pushState({tripId: tripId}, '', '/' + tripId);
            }
            // Show AI FAB for loaded trips (assume LLM was used if bags exist)
            document.getElementById('ai-fab').style.display = (data.bags && data.bags.length > 0) ? 'flex' : 'none';
            updateProgress();
            initResizeHandle();
            scheduleSave(); // Save the migrated state
        }

        const cubeEmojis = [
            '', '', '', '', '', '',
            '', '', '', '', '', '',
            '', '', '', '', '', '',
            '', '', '', '', '', ''
        ];

        const defaultCategoryIcons = {
            "Clothes": "",
            "Essentials": "",
            "Electronics": "",
            "Toiletries": "",
            "Medical": "",
            "Custom": ""
        };
        let categoryIcons = { ...defaultCategoryIcons };

        // Trip type selection
        document.querySelectorAll('.trip-type-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.trip-type-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input').checked = true;
                updateVisibility();
            });
        });

        // Toggle items
        document.querySelectorAll('.toggle-item').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                this.classList.toggle('active');
                updateVisibility();
            });
        });

        function getTripType() {
            return document.querySelector('input[name="trip_type"]:checked').value;
        }

        function updateVisibility() {
            const tripType = getTripType();
            const isMultiDay = tripType !== 'solo_day';
            const isInternational = document.querySelector('[data-option="is_international"]').classList.contains('active');
            const isRecording = document.querySelector('[data-option="recording"]').classList.contains('active');

            document.getElementById('days-section').style.display = isMultiDay ? 'block' : 'none';
            document.getElementById('international-toggle').style.display = isMultiDay ? '' : 'none';
            document.getElementById('pajamas-toggle').style.display = (isMultiDay && days >= 2) ? '' : 'none';
            document.getElementById('valet-toggle').style.display = (isMultiDay && !isInternational) ? '' : 'none';
            document.getElementById('recording-toggle').style.display = isMultiDay ? '' : 'none';
            document.getElementById('intense-recording-toggle').style.display = isRecording ? '' : 'none';
        }

        function updateAiOptions() {
            const strategy = document.getElementById('strategy-select').value;
            document.getElementById('ai-options').style.display = strategy === 'llm' ? 'block' : 'none';
            if (strategy === 'llm') {
                refreshPromptPreview();
            }
        }

        function buildPrompt() {
            const tripType = getTripType();
            const actualDays = tripType === 'solo_day' ? 1 : days;

            const tripDesc = {
                'solo_day': 'solo day trip',
                'solo_multi': 'solo multi-day trip',
                'family_multi': 'family multi-day trip'
            }[tripType] || 'trip';

            const opts = [];
            if (document.querySelector('[data-option="is_work_trip"]')?.classList.contains('active')) opts.push('work trip');
            if (document.querySelector('[data-option="is_international"]')?.classList.contains('active')) opts.push('international');
            if (document.querySelector('[data-option="outside_time"]')?.classList.contains('active')) opts.push('outdoor activities');
            if (document.querySelector('[data-option="beach_pool"]')?.classList.contains('active')) opts.push('beach/pool');
            if (document.querySelector('[data-option="formal"]')?.classList.contains('active')) opts.push('formal event');
            if (document.querySelector('[data-option="cold_wet"]')?.classList.contains('active')) opts.push('cold/wet weather');
            if (document.querySelector('[data-option="pajamas"]')?.classList.contains('active')) opts.push('bring pajamas');
            if (document.querySelector('[data-option="valet"]')?.classList.contains('active')) opts.push('valet parking');
            if (document.querySelector('[data-option="recording"]')?.classList.contains('active')) opts.push('video recording');
            if (document.querySelector('[data-option="intense_recording"]')?.classList.contains('active')) opts.push('intensive recording');

            const optsText = opts.length > 0 ? opts.join(', ') : 'standard trip';

            return `Generate packing list for ${actualDays}-day ${tripDesc}. Options: ${optsText}.

ABOUT ME (use these specific items):
- Clothes: underwear=days+1, socks=days+1, t-shirts=days, pants=ceil(days/2), jacket (always), pijamas, "Consult with Gisue on clothes"=1
- Electronics: personal laptop, iPhone brick, AirPods, AirTags (3: backpack/suitcase/fanny), charging cube with charger+cable, Anker 3x charger, USB-C cables, USB C to triple, XREAL One Pro + XREAL usb, game controller, mid-size battery pack
- Essentials: wallet, credit cards, driver's license, passport, glasses wipes, ear plugs, pen, notebook, sunglasses, tesla key, office key, field note
- Medical: CPAP machine + CPAP charger + CPAP mask + CPAP filter + CPAP filter humidx (overnight only), weekly medication box, exceptional medication box, electrolytes, eye drops, Nurtec, Advil, Tylenol, band aids
- Toiletries: toothbrush, toothpaste, deodorant, mouthwash, floss, stuff from solage
- Work items: work laptop, work phone, work badge, Work YK
- Mobility: cane (in cane bag)
- If recording: GoPro small kit. If intensive: GoPro extended kit + extra batteries
- If international: passports (2), currency, international adapter
- If formal: suit, formal shirts (2), formal pants (2), black socks (2), tie, black shoes, contact lenses
- If beach/pool: swimsuit, hat, sunglasses

BAG ORGANIZATION (always create these bags):
1.  Backpack (carry-on): personal laptop, charging cube, work phone, iPhone brick, weekly medication box, eye drops, jacket for plane, AirTag
   -  Fanny Pack (nested in Backpack): wallet, credit cards, driver's license, keys (tesla, office), AirPods, sunglasses, work badge, Work YK, exceptional medication box, ear plugs, notebook
2.  Suitcase (checked): CPAP equipment, clothes (pants, shirts, underwear, socks, pijamas), work laptop, electrolytes, AirTag
   -  Toiletry (nested in Suitcase): all toiletries + medications (Advil, Tylenol, Nurtec, band aids) + CPAP filters + glasses wipes
   -  Tech Pouch (nested in Suitcase): Anker charger, USB cables, battery pack, game controller, pen
   -  XREAL BAG (nested in Suitcase): XREAL One Pro + XREAL usb
3.  Cane bag (separate): cane

Return ONLY JSON (no markdown) with this structure:
{
  "categories": {"Clothes":{"item":{"qty":1,"weight":150}},"Electronics":{"item":{"qty":1,"weight":200}},...},
  "bags": [{"name":"Bag Name","emoji":"","parent":"suitcase|backpack|null","items":["item name"]}]
}
For each item, provide qty (quantity) and weight (estimated weight in grams per item).
Weight guidelines: laptop ~1500g, phone ~200g, chargers ~100g, batteries ~300g, clothes vary (socks ~50g, underwear ~30g, t-shirt ~150g, pants ~400g, jacket ~600g), toiletries travel-size ~50-100g each, documents ~20g.
ALWAYS include the bags array with the organization above.`;
        }

        function refreshPromptPreview() {
            document.getElementById('prompt-editor').value = buildPrompt();
        }

        // Sensitive toggle click handler
        document.getElementById('sensitive-toggle').addEventListener('click', function(e) {
            e.preventDefault();
            this.classList.toggle('active');
        });

        function updateDays(value) {
            days = parseInt(value);
            document.getElementById('days-display').textContent = days + (days === 1 ? ' day' : ' days');
            updateVisibility();
        }

        // Generate random trip ID
        function generateTripId() {
            const adjectives = ['happy', 'sunny', 'swift', 'calm', 'bold', 'bright', 'cool', 'warm', 'wild', 'free'];
            const nouns = ['voyage', 'journey', 'trip', 'quest', 'trail', 'path', 'route', 'trek', 'jaunt', 'tour'];
            return adjectives[Math.floor(Math.random() * adjectives.length)] + '-' + nouns[Math.floor(Math.random() * nouns.length)];
        }

        async function generateList() {
            const tripType = getTripType();
            const actualDays = tripType === 'solo_day' ? 1 : days;
            const strategy = document.getElementById('strategy-select').value;
            const customPrompt = strategy === 'llm' ? document.getElementById('prompt-editor').value : null;

            const options = {};
            document.querySelectorAll('.toggle-item:not(#sensitive-toggle)').forEach(item => {
                options[item.dataset.option] = item.classList.contains('active');
            });

            // Show loading state
            const btn = document.querySelector('.btn-generate');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = ' Asking GPT-4...';

            // Show generation progress
            showGenerationProgress('gpt-4o');

            try {
                const prompt = customPrompt || buildPrompt();
                const resp = await fetch(PROXY_URL + '/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 4000
                    })
                });
                if (!resp.ok) throw new Error('API call failed');
                const result = await resp.json();
                const content = result.choices[0].message.content;

                // Parse JSON from response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('No JSON in response');
                const parsed = JSON.parse(jsonMatch[0]);

                const data = {
                    packing_list: parsed.categories || parsed,
                    bags: parsed.bags || [],
                    trip_id: generateTripId()
                };
                currentList = data.packing_list;
                currentTripId = data.trip_id;
                itemStates = {};
                suitcaseItems = [];
                backpackItems = [];
                customItems = [];
                packingCubes = {};
                itemIdCounter = 0;
                cubeIdCounter = 0;
                categoryIcons = { ...defaultCategoryIcons };

                // Create default suitcase and backpack bags
                normalizeCubes();

                // Update URL hash for client-side routing
                window.location.hash = currentTripId;

                // Update trip display
                updateTripDisplay();

                renderPackingList(currentList);

                // Apply bags from LLM response (creates cubes and assigns items)
                if (data.bags && data.bags.length > 0) {
                    applyBagsFromLLM(data.bags);
                }

                renderCubes();
                document.getElementById('form-section').style.display = 'none';
                document.getElementById('results').classList.add('active');
                document.querySelector('.container').classList.add('wide');
                document.body.classList.add('no-scroll');
                updateProgress();
                updateBagCounts();
                initResizeHandle();

                // Show AI FAB
                document.getElementById('ai-fab').style.display = 'flex';

                // Save trip to localStorage
                saveTripState();

                // Hide progress overlay
                hideGenerationProgress();

                // Restore button
                btn.disabled = false;
                btn.textContent = originalText;
            } catch(e) {
                console.error('Error:', e);
                hideGenerationProgress();
                btn.disabled = false;
                btn.textContent = originalText;
                alert('Error generating list: ' + e.message);
            }
        }

        function renderPackingList(list) {
            const container = document.getElementById('packing-list');
            let html = '';

            for (const [category, items] of Object.entries(list)) {
                if (Object.keys(items).length === 0) continue;
                // Skip Custom category here - it's rendered separately from customItems
                if (category === 'Custom') continue;
                html += renderCategory(category, items);
            }

            // Add custom items category if there are any
            if (customItems.length > 0) {
                html += renderCustomCategory();
            }

            container.innerHTML = html;
            updateCategoryDropdown();
            setupDragAndDrop();
            setupItemClicks();
            applySelectionStyles();
        }

        function renderCategory(category, items) {
            const icon = categoryIcons[category] || "";
            let html = `
                <div class="category" data-category="${category}">
                    <div class="category-header">
                        <span class="category-icon">${icon}</span>
                        <span class="category-name">${category}</span>
                    </div>
                    <div class="item-list">
            `;

            for (const [item, value] of Object.entries(items)) {
                // Handle both old format (count as number) and new format ({qty, weight})
                let count, weight;
                if (typeof value === 'object' && value !== null) {
                    count = value.qty || 1;
                    weight = value.weight || null;
                } else {
                    count = value;
                    weight = null;
                }

                // Find existing item by name, or create new ID
                let itemId = findItemIdByName(item, category);
                if (!itemId) {
                    itemId = `item-${itemIdCounter++}`;
                    itemStates[itemId] = { packed: false, bag: null, name: item, count: count, category: category, cube: null, weight: weight };
                } else if (weight && !itemStates[itemId].weight) {
                    // Update weight if we got new weight data
                    itemStates[itemId].weight = weight;
                }
                html += renderItem(itemId, item, count);
            }

            // Add inline (+) button
            html += `<div class="add-item-inline" data-category="${category}" onclick="showInlineAddInput(this, '${category}')">+</div>`;
            html += '</div></div>';
            return html;
        }

        function findItemIdByName(name, category) {
            // Look for an existing item with this name (and optionally category)
            for (const [id, state] of Object.entries(itemStates)) {
                if (state.name === name && (!category || state.category === category)) {
                    return id;
                }
            }
            return null;
        }

        function renderCustomCategory() {
            const icon = categoryIcons["Custom"];
            let html = `
                <div class="category" data-category="Custom">
                    <div class="category-header">
                        <span class="category-icon">${icon}</span>
                        <span class="category-name">Custom</span>
                    </div>
                    <div class="item-list" id="custom-items-list">
            `;

            for (const customItem of customItems) {
                html += renderItem(customItem.id, customItem.name, 1);
            }

            // Add inline (+) button
            html += `<div class="add-item-inline" data-category="Custom" onclick="showInlineAddInput(this, 'Custom')">+</div>`;
            html += '</div></div>';
            return html;
        }

        function renderItem(itemId, name, count) {
            const state = itemStates[itemId] || { packed: false, bag: null, cube: null };

            // Hide items that are packed in a bag - they show in the bag modal instead
            if (state.cube) {
                return '';
            }

            const countBadge = `<span class="item-count" onclick="event.stopPropagation(); editItemCount('${itemId}')">${count || 1}</span>`;

            // Weight display and sizing
            const weight = state.weight;
            const weightDisplay = weight ? formatWeight(weight * (count || 1)) : '';
            const weightBadge = `<span class="item-weight" onclick="event.stopPropagation(); editItemWeight('${itemId}')">${weightDisplay}</span>`;
            const weightClass = weight ? getWeightClass(weight) : '';

            return `<div class="item ${weightClass}" data-item-id="${itemId}" draggable="true">
                <span class="item-name" onclick="event.stopPropagation(); editItemName('${itemId}')">${name}</span>${countBadge}${weightBadge}
            </div>`;
        }

        function setupItemClicks() {
            document.querySelectorAll('.item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.classList.contains('item-count') || e.target.classList.contains('item-weight') || e.target.classList.contains('item-name')) return;
                    const itemId = this.dataset.itemId;
                    if (e.metaKey || e.ctrlKey) {
                        toggleSelection(itemId);
                    } else {
                        clearSelection();
                        togglePacked(itemId);
                    }
                });
            });
        }

        function togglePacked(itemId) {
            if (!itemStates[itemId]) return;
            itemStates[itemId].packed = !itemStates[itemId].packed;

            const el = document.querySelector(`[data-item-id="${itemId}"]`);
            if (el) {
                el.classList.toggle('packed', itemStates[itemId].packed);
            }
            updateProgress();
            scheduleSave();
        }

        function editItemCount(itemId) {
            const state = itemStates[itemId];
            if (!state) return;

            const currentCount = state.count || 1;
            const newCount = prompt(`Quantity for "${state.name}":`, currentCount);

            if (newCount === null) return; // Cancelled

            const parsed = parseInt(newCount, 10);
            if (isNaN(parsed) || parsed < 1) {
                showStatus('Please enter a valid number (1 or more)', 'error');
                return;
            }

            pushHistory();
            state.count = parsed;

            // Update the count in currentList too
            if (currentList && state.category && currentList[state.category] && currentList[state.category][state.name]) {
                currentList[state.category][state.name].qty = parsed;
            }

            renderPackingList(currentList);
            renderCubes();
            updateProgress();
            scheduleSave();

            // Refresh modal if open
            if (currentOpenBag && packingCubes[currentOpenBag]) {
                openCubeModal(currentOpenBag);
            }
        }

        let currentWeightEditItemId = null;

        function editItemWeight(itemId) {
            const state = itemStates[itemId];
            if (!state) return;

            currentWeightEditItemId = itemId;
            document.getElementById('weight-modal-item-name').textContent = state.name;
            const input = document.getElementById('weight-input');
            input.value = state.weight || '';
            document.getElementById('weight-modal').classList.add('visible');
            input.focus();
            input.select();
        }

        // Keyboard support for weight modal
        document.addEventListener('keydown', function(e) {
            if (!document.getElementById('weight-modal').classList.contains('visible')) return;
            if (e.key === 'Escape') {
                closeWeightModal();
            } else if (e.key === 'Enter' && document.activeElement.id === 'weight-input') {
                e.preventDefault();
                saveWeightFromModal();
            }
        });

        function closeWeightModal() {
            document.getElementById('weight-modal').classList.remove('visible');
            currentWeightEditItemId = null;
        }

        function closeWeightModalOnOverlay(event) {
            if (event.target.id === 'weight-modal') {
                closeWeightModal();
            }
        }

        function saveWeightFromModal() {
            if (!currentWeightEditItemId) return;

            const state = itemStates[currentWeightEditItemId];
            if (!state) return;

            const input = document.getElementById('weight-input').value;
            const parsed = parseInt(input, 10);

            if (input === '' || isNaN(parsed) || parsed < 0) {
                showStatus('Please enter a valid weight in grams', 'error');
                return;
            }

            pushHistory();
            state.weight = parsed;

            // Update the weight in currentList too
            if (currentList && state.category && currentList[state.category] && currentList[state.category][state.name]) {
                currentList[state.category][state.name].weight = parsed;
            }

            renderPackingList(currentList);
            renderCubes();
            scheduleSave();

            // Refresh bag modal if open
            if (currentOpenBag && packingCubes[currentOpenBag]) {
                openCubeModal(currentOpenBag);
            }

            closeWeightModal();
        }

        // Rename Item functionality
        let currentRenameItemId = null;

        function editItemName(itemId) {
            const state = itemStates[itemId];
            if (!state) return;

            currentRenameItemId = itemId;
            const input = document.getElementById('rename-input');
            input.value = state.name;
            document.getElementById('rename-modal').classList.add('visible');
            input.focus();
            input.select();
        }

        function closeRenameModal() {
            document.getElementById('rename-modal').classList.remove('visible');
            currentRenameItemId = null;
        }

        function closeRenameModalOnOverlay(event) {
            if (event.target.id === 'rename-modal') {
                closeRenameModal();
            }
        }

        function saveRenameFromModal() {
            if (!currentRenameItemId) return;

            const state = itemStates[currentRenameItemId];
            if (!state) return;

            const newName = document.getElementById('rename-input').value.trim();
            if (!newName) {
                showStatus('Please enter a name', 'error');
                return;
            }

            pushHistory();
            const oldName = state.name;
            state.name = newName;

            // Update in currentList
            if (currentList && state.category && currentList[state.category]) {
                if (currentList[state.category][oldName]) {
                    const data = currentList[state.category][oldName];
                    delete currentList[state.category][oldName];
                    currentList[state.category][newName] = data;
                }
            }

            renderPackingList(currentList);
            renderCubes();
            scheduleSave();

            // Refresh bag modal if open
            if (currentOpenBag && packingCubes[currentOpenBag]) {
                openCubeModal(currentOpenBag);
            }

            closeRenameModal();
            showStatus('Item renamed', 'success');
        }

        // Keyboard support for rename modal
        document.addEventListener('keydown', function(e) {
            if (!document.getElementById('rename-modal').classList.contains('visible')) return;
            if (e.key === 'Escape') {
                closeRenameModal();
            } else if (e.key === 'Enter' && document.activeElement.id === 'rename-input') {
                e.preventDefault();
                saveRenameFromModal();
            }
        });

        async function estimateWeightFromModal() {
            if (!currentWeightEditItemId) return;
            const state = itemStates[currentWeightEditItemId];
            if (!state) return;

            const btn = document.querySelector('.weight-btn-estimate');
            btn.disabled = true;
            btn.textContent = ' Estimating...';

            try {
                const weight = await estimateWeightViaAI(state.name, state.category || 'Other');

                // Show the estimated weight in the input field
                document.getElementById('weight-input').value = weight;
                showStatus(`Estimated: ${formatWeight(weight)}`, 'success');

            } catch (e) {
                console.error('Weight estimation error:', e);
                showStatus('Failed to estimate weight', 'error');
            }

            btn.disabled = false;
            btn.textContent = ' Auto-estimate';
        }

        async function estimateSingleWeight(itemId) {
            const state = itemStates[itemId];
            if (!state) return;

            showStatus(`Estimating weight for ${state.name}...`, 'info');

            try {
                const weight = await estimateWeightViaAI(state.name, state.category || 'Other');

                pushHistory();
                state.weight = weight;

                // Update the weight in currentList too
                if (currentList && state.category && currentList[state.category] && currentList[state.category][state.name]) {
                    currentList[state.category][state.name].weight = weight;
                }

                renderPackingList(currentList);
                renderCubes();
                scheduleSave();

                // Refresh modal if open
                if (currentOpenBag && packingCubes[currentOpenBag]) {
                    openCubeModal(currentOpenBag);
                }

                showStatus(`${state.name}: ${formatWeight(weight)}`, 'success');

            } catch (e) {
                console.error('Weight estimation error:', e);
                showStatus('Failed to estimate weight', 'error');
            }
        }

        function toggleSelection(itemId) {
            if (selectedItems.includes(itemId)) {
                selectedItems = selectedItems.filter(id => id !== itemId);
            } else {
                selectedItems.push(itemId);
            }
            applySelectionStyles();
            updateSelectionButton();
        }

        function clearSelection() {
            if (selectedItems.length === 0) return;
            selectedItems = [];
            applySelectionStyles();
            updateSelectionButton();
        }

        function applySelectionStyles() {
            document.querySelectorAll('.item').forEach(el => {
                const id = el.dataset.itemId;
                el.classList.toggle('selected', selectedItems.includes(id));
            });
        }

        function updateSelectionButton() {
            const btn = document.getElementById('create-from-selection-btn');
            if (btn) {
                btn.disabled = selectedItems.length === 0;
                btn.textContent = selectedItems.length > 0 ? ` From Selection (${selectedItems.length})` : ' From Selection';
            }
        }

        function setupDragAndDrop() {
            // Drag start/end on items
            document.querySelectorAll('.item').forEach(item => {
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.itemId);
                    this.classList.add('dragging');
                });
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
            });

            // Trash zone for deletion
            const trashZone = document.getElementById('trash-zone');
            trashZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('drag-over');
            });
            trashZone.addEventListener('dragleave', function() {
                this.classList.remove('drag-over');
            });
            trashZone.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('drag-over');
                const data = e.dataTransfer.getData('text/plain');
                if (data.startsWith('cube:')) {
                    deleteCube(data.replace('cube:', ''));
                } else {
                    deleteItem(data);
                }
            });

            // Touch events for mobile
            setupTouchDrag();
        }

        // Touch drag-and-drop for mobile
        let touchDragItem = null;
        let touchDragClone = null;
        let touchDragOrigin = null;
        let touchStartX = 0;
        let touchStartY = 0;
        let touchMoved = false;

        function setupTouchDrag() {
            document.querySelectorAll('.item').forEach(item => {
                item.addEventListener('touchstart', handleTouchStart, { passive: false });
                item.addEventListener('touchmove', handleTouchMove, { passive: false });
                item.addEventListener('touchend', handleTouchEnd);
            });
        }

        // Allow Enter to add item in bag modal
        document.getElementById('modal-add-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addItemToCurrentBag();
            }
        });

        function handleTouchStart(e) {
            if (e.touches.length !== 1) return;

            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            touchMoved = false;
            touchDragOrigin = this;

            // Delay to distinguish tap from drag
            this.touchTimeout = setTimeout(() => {
                if (!touchMoved) {
                    startTouchDrag(this, touch);
                }
            }, 150);
        }

        function startTouchDrag(item, touch) {
            touchDragItem = item.dataset.itemId;

            // Create visual clone
            touchDragClone = item.cloneNode(true);
            touchDragClone.classList.add('touch-dragging');
            touchDragClone.style.left = (touch.clientX - 50) + 'px';
            touchDragClone.style.top = (touch.clientY - 20) + 'px';
            document.body.appendChild(touchDragClone);

            // Dim the original
            item.classList.add('touch-origin');
        }

        function handleTouchMove(e) {
            const touch = e.touches[0];
            const dx = Math.abs(touch.clientX - touchStartX);
            const dy = Math.abs(touch.clientY - touchStartY);

            if (dx > 10 || dy > 10) {
                touchMoved = true;
                e.preventDefault();

                if (!touchDragClone && touchDragOrigin) {
                    startTouchDrag(touchDragOrigin, touch);
                }

                if (touchDragClone) {
                    touchDragClone.style.left = (touch.clientX - 50) + 'px';
                    touchDragClone.style.top = (touch.clientY - 20) + 'px';

                    // Highlight drop zones
                    highlightDropZone(touch.clientX, touch.clientY);
                }
            }
        }

        function highlightDropZone(x, y) {
            // Check trash zone
            const trashEl = document.getElementById('trash-zone');
            if (trashEl) {
                const rect = trashEl.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    trashEl.classList.add('drag-over');
                } else {
                    trashEl.classList.remove('drag-over');
                }
            }

            // Check cubes (bags)
            document.querySelectorAll('.packing-cube').forEach(cube => {
                const rect = cube.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    cube.classList.add('drag-over');
                } else {
                    cube.classList.remove('drag-over');
                }
            });
        }

        function handleTouchEnd(e) {
            clearTimeout(this.touchTimeout);

            if (touchDragClone) {
                const touch = e.changedTouches[0];
                const dropTarget = findDropTarget(touch.clientX, touch.clientY);

                if (dropTarget && touchDragItem) {
                    if (dropTarget.type === 'trash') {
                        deleteItem(touchDragItem);
                    } else if (dropTarget.type === 'cube') {
                        assignToCube(touchDragItem, dropTarget.id);
                        triggerDropAnimation(dropTarget.id);
                    }
                }

                // Cleanup
                document.body.removeChild(touchDragClone);
                touchDragClone = null;

                // Clear all highlights
                document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            }

            if (touchDragOrigin) {
                touchDragOrigin.classList.remove('touch-origin');
            }

            // If it was a tap (not drag), toggle packed state
            if (!touchMoved && touchDragOrigin) {
                togglePacked(touchDragOrigin.dataset.itemId);
            }

            touchDragItem = null;
            touchDragOrigin = null;
            touchMoved = false;
        }

        function findDropTarget(x, y) {
            // Check trash zone
            const trashEl = document.getElementById('trash-zone');
            if (trashEl) {
                const rect = trashEl.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return { type: 'trash' };
                }
            }

            // Check cubes (bags)
            const cubes = document.querySelectorAll('.packing-cube');
            for (const cube of cubes) {
                const rect = cube.getBoundingClientRect();
                if (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom) {
                    return { type: 'cube', id: cube.dataset.cubeId };
                }
            }

            return null;
        }

        function deleteCube(cubeId) {
            const cube = packingCubes[cubeId];
            if (!cube) return;
            pushHistory();

            // Return all items in cube to unpacked state
            for (const itemId of cube.items) {
                if (itemStates[itemId]) {
                    itemStates[itemId].cube = null;
                    itemStates[itemId].packed = false;
                }
            }

            // Detach any nested cubes
            const childCubes = getChildCubes(cubeId);
            for (const child of childCubes) {
                packingCubes[child.id].parentBag = null;
            }

            // Remove from parent children arrays
            if (cube.parentBag && packingCubes[cube.parentBag]?.children) {
                packingCubes[cube.parentBag].children = packingCubes[cube.parentBag].children.filter(id => id !== cubeId);
            }
            suitcaseItems = suitcaseItems.filter(id => id !== cubeId);
            backpackItems = backpackItems.filter(id => id !== cubeId);

            // Delete cube
            delete packingCubes[cubeId];

            renderPackingList(currentList);
            renderCubes();
            updateProgress();
            scheduleSave();
        }

        function assignToBag(itemId, bag) {
            if (!itemStates[itemId]) return;
            const state = itemStates[itemId];

            // Remove from cube if in one
            if (state.cube) {
                const cube = packingCubes[state.cube];
                if (cube) {
                    cube.items = cube.items.filter(id => id !== itemId);
                }
                state.cube = null;
            }

            // Remove from previous bag if any
            if (state.bag === 'suitcase') {
                suitcaseItems = suitcaseItems.filter(id => id !== itemId);
            } else if (state.bag === 'backpack') {
                backpackItems = backpackItems.filter(id => id !== itemId);
            }

            // Add to new bag
            state.bag = bag;
            if (bag === 'suitcase') {
                suitcaseItems.push(itemId);
            } else if (bag === 'backpack') {
                backpackItems.push(itemId);
            }

            // Mark as packed
            state.packed = true;

            // Re-render to update UI properly
            renderPackingList(currentList);
            renderCubes();
            updateProgress();
            updateBagCounts();
            scheduleSave();
        }

        function deleteItem(itemId) {
            pushHistory();
            const state = itemStates[itemId];

            // Remove from cube if in one
            if (state && state.cube) {
                const cube = packingCubes[state.cube];
                if (cube) {
                    cube.items = cube.items.filter(id => id !== itemId);
                }
            }

            // Remove from bags
            suitcaseItems = suitcaseItems.filter(id => id !== itemId);
            backpackItems = backpackItems.filter(id => id !== itemId);

            // Check if it's a custom item
            const customIdx = customItems.findIndex(ci => ci.id === itemId);
            if (customIdx >= 0) {
                customItems.splice(customIdx, 1);
            }

            // Remove from currentList if it's there
            if (state && state.category && currentList[state.category]) {
                delete currentList[state.category][state.name];
            }

            // Remove from states
            delete itemStates[itemId];
            selectedItems = selectedItems.filter(id => id !== itemId);

            // Remove from DOM
            const el = document.querySelector(`[data-item-id="${itemId}"]`);
            if (el) {
                el.remove();
            }

            renderCubes();
            updateProgress();
            updateBagCounts();
            scheduleSave();
            updateSelectionButton();
        }

        function initResizeHandle() {
            const handle = document.getElementById('resize-handle');
            const rightColumn = document.getElementById('right-column');
            if (!handle || !rightColumn) return;

            let isResizing = false;
            let startX, startWidth;

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startWidth = rightColumn.offsetWidth;
                handle.classList.add('dragging');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const delta = startX - e.clientX;
                const newWidth = Math.min(Math.max(startWidth + delta, 280), 800);
                rightColumn.style.width = newWidth + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isResizing) {
                    isResizing = false;
                    handle.classList.remove('dragging');
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        }

        function updateProgress() {
            // Only count actual items (not bags), and only count as packed if in a cube
            const allItems = Object.keys(itemStates).filter(id => !id.startsWith('cube-'));
            const packedItems = allItems.filter(id => itemStates[id].cube != null);
            const total = allItems.length;
            const packed = packedItems.length;
            const remaining = total - packed;
            const percent = total > 0 ? Math.round((packed / total) * 100) : 0;

            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-percent').textContent = percent + '%';

            // Update FAB color based on progress
            const fab = document.querySelector('.progress-fab');
            if (percent === 100) {
                fab.style.background = 'var(--success-color)';
            } else if (percent >= 50) {
                fab.style.background = 'linear-gradient(135deg, #f59e0b, #10b981)';
            } else {
                fab.style.background = 'linear-gradient(135deg, #ef4444, #f59e0b)';
            }

            if (remaining === 0) {
                document.getElementById('progress-text').textContent = ` All ${total} items packed!`;
            } else {
                document.getElementById('progress-text').textContent = `${remaining} items left to pack`;
            }
        }

        // Popup functions
        function openProgressPopup() {
            document.getElementById('progress-popup').classList.add('active');
        }

        function openAiPopup() {
            document.getElementById('ai-popup').classList.add('active');
            document.getElementById('ai-action-input').focus();
        }

        function openTodoistPopup() {
            document.getElementById('todoist-popup').classList.add('active');
            document.getElementById('list-name').focus();
        }

        function closePopup(popupId) {
            document.getElementById(popupId).classList.remove('active');
        }

        function closePopupOnOverlay(event, popupId) {
            if (event.target.classList.contains('popup-overlay')) {
                closePopup(popupId);
            }
        }

        // Prompt Management
        let savedPrompts = [];
        let selectedPromptId = null;
        let llmStats = null;

        function loadLLMStats() {
            // Not needed for standalone app - using OpenAI directly
            llmStats = null;
        }

        function getEstimatedTime(model) {
            if (!llmStats || !llmStats.by_model) return 10000; // default 10s
            const modelStats = llmStats.by_model.find(m => model.includes(m.model) || m.model.includes(model));
            return modelStats ? modelStats.avg_latency_ms : 10000;
        }

        function openPromptManager() {
            savedPrompts = getPrompts();
            renderPromptList();
            document.getElementById('prompt-manager').classList.add('active');
        }

        function renderPromptList() {
            const container = document.getElementById('prompt-list');
            if (savedPrompts.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No saved prompts yet</p>';
                return;
            }
            container.innerHTML = savedPrompts.map(p => `
                <div class="prompt-item ${selectedPromptId === p.id ? 'selected' : ''}" onclick="selectPrompt('${p.id}')">
                    <div class="prompt-item-info">
                        <div class="prompt-item-name">${p.name}</div>
                        <div class="prompt-item-date">${p.created}</div>
                    </div>
                    <div class="prompt-item-actions">
                        <button class="prompt-item-btn" onclick="event.stopPropagation(); editPrompt('${p.id}')"></button>
                        <button class="prompt-item-btn danger" onclick="event.stopPropagation(); deletePrompt('${p.id}')"></button>
                    </div>
                </div>
            `).join('');
        }

        function selectPrompt(id) {
            selectedPromptId = id;
            renderPromptList();
        }

        function loadSelectedPrompt() {
            if (!selectedPromptId) return;
            const prompt = savedPrompts.find(p => p.id === selectedPromptId);
            if (prompt) {
                document.getElementById('prompt-editor').value = prompt.content;
                closePopup('prompt-manager');
            }
        }

        function saveCurrentPrompt() {
            document.getElementById('prompt-name-input').value = '';
            document.getElementById('save-prompt-popup').classList.add('active');
            document.getElementById('prompt-name-input').focus();
        }

        function confirmSavePrompt() {
            const name = document.getElementById('prompt-name-input').value.trim();
            if (!name) {
                alert('Please enter a name for the prompt');
                return;
            }
            const content = document.getElementById('prompt-editor').value;
            const prompts = getPrompts();
            prompts.push({
                id: 'prompt-' + Date.now(),
                name,
                content,
                created: new Date().toISOString().split('T')[0]
            });
            savePromptsData(prompts);
            closePopup('save-prompt-popup');
        }

        function editPrompt(id) {
            const prompt = savedPrompts.find(p => p.id === id);
            if (!prompt) return;
            const newName = window.prompt('Edit prompt name:', prompt.name);
            if (newName && newName !== prompt.name) {
                const prompts = getPrompts();
                const idx = prompts.findIndex(p => p.id === id);
                if (idx !== -1) {
                    prompts[idx].name = newName;
                    savePromptsData(prompts);
                }
                openPromptManager(); // refresh
            }
        }

        function deletePrompt(id) {
            if (!confirm('Delete this prompt?')) return;
            const prompts = getPrompts().filter(p => p.id !== id);
            savePromptsData(prompts);
            if (selectedPromptId === id) selectedPromptId = null;
            openPromptManager(); // refresh
        }

        // Preparation Management
        function openPreparationManager() {
            savedPreparations = getPreparations();
            selectedPreparationId = null;
            renderPreparationList();
            document.getElementById('preparation-manager').classList.add('active');
        }

        function renderPreparationList() {
            const container = document.getElementById('preparation-list');
            if (!container) return;
            if (!savedPreparations || savedPreparations.length === 0) {
                container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No saved preparations yet</p>';
                return;
            }
            container.innerHTML = savedPreparations.map(p => `
                <div class="prompt-item ${selectedPreparationId === p.id ? 'selected' : ''}" onclick="selectPreparation('${p.id}')">
                    <div class="prompt-item-info">
                        <div class="prompt-item-name">${p.name || p.id}</div>
                        <div class="prompt-item-date">${(p.saved_at || '')} ${p.source_trip_id ? ' from ' + p.source_trip_id : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function selectPreparation(id) {
            selectedPreparationId = id;
            renderPreparationList();
        }

        function loadSelectedPreparation() {
            if (!selectedPreparationId) return;
            const prep = savedPreparations.find(p => p.id === selectedPreparationId);
            if (!prep || !prep.data) {
                alert('Could not load that preparation.');
                return;
            }
            // Create a new trip from the preparation
            const newTripId = generateTripId();
            saveTripById(newTripId, prep.data);
            closePopup('preparation-manager');
            loadTripState(newTripId, prep.data, true);
        }

        // Generation Progress
        let generationStartTime = null;
        let generationEstimate = 10000;
        let generationInterval = null;

        function showGenerationProgress(model) {
            generationEstimate = getEstimatedTime(model);
            generationStartTime = Date.now();

            document.getElementById('generation-model').textContent = `Using ${model}`;
            document.getElementById('generation-time').textContent = `Estimated: ~${Math.round(generationEstimate/1000)}s`;
            document.getElementById('generation-progress-fill').style.width = '0%';
            document.getElementById('generation-overlay').classList.add('active');

            generationInterval = setInterval(updateGenerationProgress, 100);
        }

        function updateGenerationProgress() {
            const elapsed = Date.now() - generationStartTime;
            // Use easing function so it slows down near the end
            const rawPercent = elapsed / generationEstimate;
            const percent = Math.min(95, rawPercent * 100 * (1 - rawPercent * 0.3));
            document.getElementById('generation-progress-fill').style.width = percent + '%';

            const remaining = Math.max(0, Math.round((generationEstimate - elapsed) / 1000));
            document.getElementById('generation-time').textContent = remaining > 0 ? `~${remaining}s remaining` : 'Almost done...';
        }

        function hideGenerationProgress() {
            if (generationInterval) {
                clearInterval(generationInterval);
                generationInterval = null;
            }
            document.getElementById('generation-progress-fill').style.width = '100%';
            setTimeout(() => {
                document.getElementById('generation-overlay').classList.remove('active');
            }, 300);
        }

        // Load stats on page load
        loadLLMStats();

        // Legacy function - kept for backwards compatibility with saved trips
        function updateBagCounts() {
            // No-op - bag counts are now shown on cube badges via renderCubes()
        }

        // Legacy function for old saved trips that had suitcase/backpack as special zones
        function openBagModal(bagType) {
            // Redirect to the cube modal for suitcase/backpack
            if (packingCubes[bagType]) {
                openCubeModal(bagType);
            }
        }

        // DEPRECATED - kept for reference, items are now in packingCubes
        function legacyOpenBagModal(bagType) {
            currentOpenBag = bagType;
            currentOpenBagType = bagType;

            const items = bagType === 'suitcase' ? suitcaseItems : backpackItems;
            const icon = bagType === 'suitcase' ? '' : '';
            const title = bagType === 'suitcase' ? 'Suitcase' : 'Backpack';

            document.getElementById('modal-title').innerHTML = `${icon} ${title}`;

            const container = document.getElementById('modal-items');
            if (items.length === 0) {
                container.innerHTML = '<div class="empty-bag">No items yet. Add some below!</div>';
            } else {
                let html = '';

                // Separate cubes and loose items
                const cubesInBag = items.filter(id => id.startsWith('cube-'));
                const looseItems = items.filter(id => !id.startsWith('cube-'));

                // Render cubes as clickable sub-bags
                for (const cubeId of cubesInBag) {
                    const cube = packingCubes[cubeId];
                    if (cube) {
                        const itemCount = cube.items.length;
                        html += `
                            <div class="modal-sub-bag" onclick="openCubeModal('${cubeId}')">
                                <div class="modal-sub-bag-info">
                                    <span>${cube.emoji} ${cube.name}</span>
                                    ${itemCount > 0 ? `<span class="modal-sub-bag-count">${itemCount}</span>` : ''}
                                </div>
                                <button class="modal-item-remove" onclick="event.stopPropagation(); removeCubeFromBag('${cubeId}'); openBagModal('${bagType}');">&times;</button>
                            </div>
                        `;
                    }
                }

                // Render loose items
                if (looseItems.length > 0 && cubesInBag.length > 0) {
                    html += '<div class="modal-section-title" style="margin-top: 12px; color: var(--text-muted); font-size: 0.85rem;">Loose Items</div>';
                }
                for (const itemId of looseItems) {
                    const state = itemStates[itemId];
                    if (state) {
                        html += `
                            <div class="modal-item">
                                <span>${state.name}${state.count > 1 ? ` (${state.count})` : ''}</span>
                                <button class="modal-item-remove" onclick="removeFromBag('${itemId}', '${bagType}')">&times;</button>
                            </div>
                        `;
                    }
                }
                container.innerHTML = html;
            }

            document.getElementById('modal-add-input').value = '';
            document.getElementById('modal-add-input').placeholder = `Add item to ${title}...`;
            document.getElementById('bag-modal').classList.add('visible');
            document.getElementById('modal-add-input').focus();
        }

        function closeModal() {
            document.getElementById('bag-modal').classList.remove('visible');
            currentOpenBag = null;
            currentOpenBagType = null;
        }

        function addItemToCurrentBag() {
            const input = document.getElementById('modal-add-input');
            const name = input.value.trim();
            if (!name || !currentOpenBag) return;
            pushHistory();

            // Create a new custom item
            const itemId = `item-${itemIdCounter++}`;
            customItems.push({ id: itemId, name: name });
            itemStates[itemId] = { packed: true, bag: null, name: name, count: 1, category: 'Custom', cube: currentOpenBag };

            // Add to currentList for Todoist export
            if (!currentList['Custom']) {
                currentList['Custom'] = {};
            }
            currentList['Custom'][name] = 1;

            // Add to current bag (all bags are now cubes)
            const cube = packingCubes[currentOpenBag];
            if (cube) {
                cube.items.push(itemId);
            }

            // Update UI
            input.value = '';
            updateProgress();
            renderCubes();
            renderPackingList(currentList);
            scheduleSave();
            updateUndoRedoButtons();

            // Refresh the modal
            openCubeModal(currentOpenBag);
        }

        function removeFromBag(itemId, bagType) {
            if (!itemStates[itemId]) return;
            pushHistory();

            // Remove from bag array
            if (bagType === 'suitcase') {
                suitcaseItems = suitcaseItems.filter(id => id !== itemId);
            } else {
                backpackItems = backpackItems.filter(id => id !== itemId);
            }

            // Update state
            itemStates[itemId].bag = null;
            itemStates[itemId].packed = false;

            // Update DOM
            const el = document.querySelector(`[data-item-id="${itemId}"]`);
            if (el) {
                el.classList.remove('in-suitcase', 'in-backpack', 'packed');
            }

            updateProgress();
            updateBagCounts();
            scheduleSave();

            // Refresh modal
            openBagModal(bagType);
        }

        // Close modal on overlay click
        document.getElementById('bag-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        // Enter key to add item in modal
        document.getElementById('modal-add-input').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addItemToCurrentBag();
            }
        });

        function updateCategoryDropdown() {
            const select = document.getElementById('add-item-category');
            if (!select) return; // Element may not exist with inline add UI
            const currentValue = select.value;

            // Get all categories from currentList
            const categories = new Set(Object.keys(currentList));
            categories.add('Custom'); // Always include Custom

            // Add custom categories from categoryIcons
            for (const cat of Object.keys(categoryIcons)) {
                categories.add(cat);
            }

            // Rebuild options
            select.innerHTML = '';
            for (const cat of Array.from(categories).sort()) {
                const icon = categoryIcons[cat] || '';
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = `${icon} ${cat}`;
                select.appendChild(option);
            }

            // Restore selection if valid
            if (categories.has(currentValue)) {
                select.value = currentValue;
            }
        }

        function showInlineAddInput(btn, category) {
            // Replace the + button with an input field
            const container = document.createElement('div');
            container.className = 'inline-add-input';
            container.innerHTML = `
                <input type="text" placeholder="Item name..." autofocus>
                <button onclick="addInlineItem(this, '${category}')">Add</button>
                <button class="cancel-btn" onclick="cancelInlineAdd(this, '${category}')"></button>
            `;
            btn.replaceWith(container);

            const input = container.querySelector('input');
            input.focus();
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    addInlineItem(container.querySelector('button'), category);
                } else if (e.key === 'Escape') {
                    cancelInlineAdd(container.querySelector('.cancel-btn'), category);
                }
            });
        }

        function addInlineItem(btn, category) {
            const container = btn.parentElement;
            const input = container.querySelector('input');
            const name = input.value.trim();

            if (name) {
                pushHistory();
                const itemId = `item-${itemIdCounter++}`;

                if (category === 'Custom') {
                    customItems.push({ id: itemId, name: name });
                }

                itemStates[itemId] = { packed: false, bag: null, name: name, count: 1, category: category };

                // Add to currentList
                if (!currentList[category]) {
                    currentList[category] = {};
                }
                currentList[category][name] = 1;

                scheduleSave();
            }

            // Re-render to show new item and restore + button
            renderPackingList(currentList);
            updateProgress();
        }

        function cancelInlineAdd(btn, category) {
            // Just re-render to restore the + button
            renderPackingList(currentList);
        }

        function addItemToCategory() {
            // Legacy function - now using inline add
            const input = document.getElementById('custom-item-input');
            const categorySelect = document.getElementById('add-item-category');
            if (!input || !categorySelect) return;
            const name = input.value.trim();
            const category = categorySelect.value;
            if (!name) return;

            pushHistory();
            const itemId = `item-${itemIdCounter++}`;

            if (category === 'Custom') {
                customItems.push({ id: itemId, name: name });
            }

            itemStates[itemId] = { packed: false, bag: null, name: name, count: 1, category: category };

            // Add to currentList for Todoist export
            if (!currentList[category]) {
                currentList[category] = {};
            }
            currentList[category][name] = 1;

            // Re-render the packing list
            renderPackingList(currentList);

            input.value = '';
            updateProgress();
            scheduleSave();
        }

        function openAddCategoryModal() {
            document.getElementById('new-category-name').value = '';
            document.getElementById('new-category-icon').value = '';
            openPopup('add-category-modal');
        }

        function addNewCategory() {
            const nameInput = document.getElementById('new-category-name');
            const iconInput = document.getElementById('new-category-icon');
            const name = nameInput.value.trim();
            const icon = iconInput.value.trim() || '';

            if (!name) {
                alert('Please enter a category name');
                return;
            }

            // Add to categoryIcons
            categoryIcons[name] = icon;

            // Add empty category to currentList
            if (!currentList[name]) {
                currentList[name] = {};
            }

            // Re-render to show the new category
            renderPackingList(currentList);

            // Update the dropdown (if exists)
            updateCategoryDropdown();

            // Select the new category (if dropdown exists)
            const select = document.getElementById('add-item-category');
            if (select) select.value = name;

            closePopup('add-category-modal');
            scheduleSave();
        }

        // Legacy function for backwards compatibility
        function addCustomItem() {
            addItemToCategory();
        }

        // Enter key for AI action
        document.getElementById('ai-action-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendAiAction();
        });

        async function sendAiAction() {
            const input = document.getElementById('ai-action-input');
            const btn = document.getElementById('ai-action-btn');
            const action = input.value.trim();
            if (!action) return;

            btn.disabled = true;
            btn.textContent = ' Thinking...';

            // Build current state for context
            const itemsList = Object.values(itemStates).map(s => s.name).join(', ');
            const cubesList = Object.entries(packingCubes).map(([id, c]) => `${c.name}: ${c.items.map(i => itemStates[i]?.name || i).join(', ')}`).join('; ');

            const prompt = `You are a packing assistant. The user has these items: ${itemsList}

Current bags/cubes: ${cubesList}

User request: "${action}"

Respond with a JSON object describing changes. Available actions:
- create_cubes: [{emoji: "", name: "Cube Name", bag: "suitcase"|"backpack"}]
- move_to_bag: [{item: "item name", bag: "suitcase"|"backpack"}]
- move_to_cube: [{item: "item name", cube: "cube name"}]
- add_items: [{name: "item name", category: "Category", count: 1}]
- remove_items: ["item name"]

Only include actions needed. Example response:
{"move_to_cube": [{"item": "toothbrush", "cube": "Toiletry"}]}`;

            try {
                const resp = await fetch(PROXY_URL + '/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 2000
                    })
                });
                const data = await resp.json();
                if (data.error) throw new Error(data.error.message || 'API error');

                const content = data.choices[0].message.content.trim();
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error('Could not parse response');

                const changes = JSON.parse(jsonMatch[0]);
                applyAiChanges(changes);
                input.value = '';
                document.getElementById('model-badge').textContent = ' Model: gpt-4o';

            } catch (e) {
                console.error('AI action error:', e);
                alert('Error: ' + e.message);
            }

            btn.disabled = false;
            btn.textContent = 'Send';
        }

        function applyBagsFromLLM(bags) {
            // Create cubes from LLM bags and assign items
            for (const bag of bags) {
                const cubeId = `cube-${cubeIdCounter++}`;
                packingCubes[cubeId] = {
                    emoji: bag.emoji || '',
                    name: bag.name || 'Bag',
                    parentBag: bag.parent || 'suitcase',
                    items: [],
                    children: []
                };
                if (packingCubes[packingCubes[cubeId].parentBag]?.children) {
                    if (!packingCubes[packingCubes[cubeId].parentBag].children.includes(cubeId)) {
                        packingCubes[packingCubes[cubeId].parentBag].children.push(cubeId);
                    }
                }

                // Find and assign items to this cube
                if (bag.items && bag.items.length > 0) {
                    for (const itemName of bag.items) {
                        const parentTarget = bag.parent || 'suitcase';
                        // Search for matching item in itemStates
                        for (const [itemId, state] of Object.entries(itemStates)) {
                            if (state.name.toLowerCase().includes(itemName.toLowerCase()) ||
                                itemName.toLowerCase().includes(state.name.toLowerCase())) {
                                state.packed = true;
                                state.bag = (parentTarget === 'suitcase' || parentTarget === 'backpack') ? parentTarget : null;
                                state.cube = cubeId;
                                packingCubes[cubeId].items.push(itemId);

                                // Update bag arrays
                                if (parentTarget === 'backpack') {
                                    if (!backpackItems.includes(itemId)) backpackItems.push(itemId);
                                } else if (parentTarget === 'suitcase') {
                                    if (!suitcaseItems.includes(itemId)) suitcaseItems.push(itemId);
                                }

                                // Update DOM
                                const el = document.querySelector(`[data-item-id="${itemId}"]`);
                                if (el) {
                                    el.classList.add('packed', bag.parent === 'backpack' ? 'in-backpack' : 'in-suitcase');
                                }
                                break; // Only match first item
                            }
                        }
                    }
                }
            }
            normalizeCubes();
        }

        function applyAiChanges(changes) {
            if (!changes) return;

            // Handle creating packing cubes
            if (changes.create_cubes) {
                for (const cube of changes.create_cubes) {
                    const cubeId = `cube-${cubeIdCounter++}`;
                    packingCubes[cubeId] = {
                        emoji: cube.emoji || '',
                        name: cube.name || 'Cube',
                        parentBag: cube.bag || 'suitcase',
                        items: [],
                        children: []
                    };
                    if (packingCubes[cube.bag || 'suitcase']?.children && !packingCubes[cube.bag || 'suitcase'].children.includes(cubeId)) {
                        packingCubes[cube.bag || 'suitcase'].children.push(cubeId);
                    }
                }
                renderCubes();
            }

            // Handle moving items to bags
            if (changes.move_to_bag) {
                for (const move of changes.move_to_bag) {
                    // Find item by name
                    for (const [itemId, state] of Object.entries(itemStates)) {
                        if (state.name.toLowerCase().includes(move.item.toLowerCase())) {
                            state.packed = true;
                            state.bag = move.bag;
                            if (move.bag === 'suitcase') {
                                if (!suitcaseItems.includes(itemId)) suitcaseItems.push(itemId);
                                backpackItems = backpackItems.filter(id => id !== itemId);
                            } else if (move.bag === 'backpack') {
                                if (!backpackItems.includes(itemId)) backpackItems.push(itemId);
                                suitcaseItems = suitcaseItems.filter(id => id !== itemId);
                            }
                            // Update DOM
                            const el = document.querySelector(`[data-item-id="${itemId}"]`);
                            if (el) {
                                el.classList.add('packed', move.bag === 'suitcase' ? 'in-suitcase' : 'in-backpack');
                            }
                            break;
                        }
                    }
                }
            }

            // Handle moving items to cubes
            if (changes.move_to_cube) {
                for (const move of changes.move_to_cube) {
                    // Find the cube
                    let targetCubeId = null;
                    for (const [cubeId, cube] of Object.entries(packingCubes)) {
                        if (cube.name.toLowerCase().includes(move.cube.toLowerCase())) {
                            targetCubeId = cubeId;
                            break;
                        }
                    }
                    if (!targetCubeId) continue;

                    // Find the item
                    for (const [itemId, state] of Object.entries(itemStates)) {
                        if (state.name.toLowerCase().includes(move.item.toLowerCase())) {
                            state.packed = true;
                            const parentTarget = packingCubes[targetCubeId].parentBag;
                            state.bag = (parentTarget === 'suitcase' || parentTarget === 'backpack') ? parentTarget : null;
                            state.cube = targetCubeId;
                            packingCubes[targetCubeId].items.push(itemId);
                            // Update DOM
                            const el = document.querySelector(`[data-item-id="${itemId}"]`);
                            if (el) {
                                el.classList.add('packed', 'in-suitcase');
                            }
                            break;
                        }
                    }
                }
            }

            normalizeCubes();
            updateProgress();
            updateBagCounts();
            renderCubes();
            scheduleSave();
        }

        function saveToTodoist() {
            // Todoist integration not available in client-side version
            showStatus('Todoist integration not available in this version', 'info');
        }

        function showStatus(message, type) {
            const el = document.getElementById('status-message');
            el.textContent = message;
            el.className = 'status-message ' + type;
        }

        function resetForm() {
            document.getElementById('form-section').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('status-message').className = 'status-message';
            document.querySelector('.btn-save').disabled = false;
            document.querySelector('.btn-save').innerHTML = '<span></span> Save to Todoist';
            document.getElementById('list-name').value = '';
            currentList = null;
            itemStates = {};
            suitcaseItems = [];
            backpackItems = [];
            customItems = [];
            packingCubes = {};
            cubeIdCounter = 0;
        }

        // ========== PACKING CUBES ==========

        function ensureDefaultBags() {
            // Create suitcase and backpack as default bags if they don't exist
            if (!packingCubes['suitcase']) {
                packingCubes['suitcase'] = {
                    emoji: '',
                    name: 'Suitcase',
                    parentBag: null,
                    items: [],
                    children: []
                };
            }
            if (!packingCubes['backpack']) {
                packingCubes['backpack'] = {
                    emoji: '',
                    name: 'Backpack',
                    parentBag: null,
                    items: [],
                    children: []
                };
            }
        }

        function normalizeCubes() {
            ensureDefaultBags();
            // Reset children lists and rebuild from parent pointers
            for (const cube of Object.values(packingCubes)) {
                cube.children = [];
            }
            for (const [cubeId, cube] of Object.entries(packingCubes)) {
                if (!cube.items) cube.items = [];
                if (cube.children === undefined) cube.children = [];
                if (cube.parent === undefined && cube.parentBag === undefined) {
                    cube.parentBag = null;
                }
                if (cube.parent !== undefined && cube.parentBag === undefined) {
                    cube.parentBag = cube.parent;
                    delete cube.parent;
                }
                if (cube.parentBag && packingCubes[cube.parentBag]) {
                    if (!packingCubes[cube.parentBag].children.includes(cubeId)) {
                        packingCubes[cube.parentBag].children.push(cubeId);
                    }
                }
            }
        }

        function snapshotState() {
            return JSON.stringify({
                itemStates,
                packingCubes,
                suitcaseItems,
                backpackItems,
                customItems,
                currentList,
                itemIdCounter,
                cubeIdCounter,
                categoryIcons,
                selectedItems
            });
        }

        function restoreState(serialized) {
            const state = JSON.parse(serialized);
            itemStates = state.itemStates || {};
            packingCubes = state.packingCubes || {};
            suitcaseItems = state.suitcaseItems || [];
            backpackItems = state.backpackItems || [];
            customItems = state.customItems || [];
            currentList = state.currentList || currentList;
            itemIdCounter = state.itemIdCounter || itemIdCounter;
            cubeIdCounter = state.cubeIdCounter || cubeIdCounter;
            categoryIcons = state.categoryIcons || categoryIcons;
            selectedItems = state.selectedItems || [];
            normalizeCubes();
            renderPackingList(currentList);
            renderCubes();
            updateProgress();
            updateUndoRedoButtons();
            scheduleSave();
        }

        function pushHistory() {
            if (historySuspended) return;
            undoStack.push(snapshotState());
            if (undoStack.length > HISTORY_LIMIT) undoStack.shift();
            redoStack = [];
            updateUndoRedoButtons();
        }

        function undoAction() {
            if (undoStack.length === 0) return;
            const current = snapshotState();
            const prev = undoStack.pop();
            redoStack.push(current);
            restoreState(prev);
        }

        function redoAction() {
            if (redoStack.length === 0) return;
            const current = snapshotState();
            const next = redoStack.pop();
            undoStack.push(current);
            restoreState(next);
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            if (undoBtn) undoBtn.disabled = undoStack.length === 0;
            if (redoBtn) redoBtn.disabled = redoStack.length === 0;
        }

        function getChildCubes(parentId) {
            return Object.entries(packingCubes)
                .filter(([_, cube]) => cube.parentBag === parentId)
                .map(([id, cube]) => ({ id, ...cube }));
        }

        function getBreadcrumb(cubeId) {
            const path = [];
            let current = cubeId;
            while (current && packingCubes[current]) {
                path.unshift({ id: current, name: packingCubes[current].name, emoji: packingCubes[current].emoji });
                current = packingCubes[current].parentBag;
            }
            return path;
        }

        function isAncestor(candidateId, cubeId) {
            let current = packingCubes[cubeId]?.parentBag;
            while (current) {
                if (current === candidateId) return true;
                current = packingCubes[current]?.parentBag;
            }
            return false;
        }

        function renderCubes() {
            const grid = document.getElementById('cubes-grid');
            let html = '';

            let colorIndex = 0;
            for (const [cubeId, cube] of Object.entries(packingCubes)) {
                if (cube.parentBag) continue; // Nested cubes are shown inside their parent only
                const itemCount = cube.items.length;
                const childCount = cube.children ? cube.children.length : getChildCubes(cubeId).length;
                const totalCount = itemCount + childCount;
                const countBadge = totalCount > 0 ? `<span class="cube-count">${totalCount}</span>` : '';

                // Calculate total weight for this cube
                const totalWeight = getCubeTotalWeight(cubeId);
                const weightBadge = totalWeight > 0 ? `<span class="cube-weight">${formatWeight(totalWeight)}</span>` : '';

                // Size class based on weight (with fallback to item count if no weights)
                let sizeClass;
                if (totalWeight > 0) {
                    sizeClass = getCubeSizeClass(totalWeight);
                } else {
                    // Fallback to count-based sizing
                    sizeClass = 'size-small';
                    if (totalCount >= 10) sizeClass = 'size-xlarge';
                    else if (totalCount >= 5) sizeClass = 'size-large';
                    else if (totalCount >= 2) sizeClass = 'size-medium';
                }

                // Color class based on index
                const colorClass = `color-${colorIndex % 8}`;
                colorIndex++;

                html += `
                    <div class="packing-cube ${sizeClass} ${colorClass}" data-cube-id="${cubeId}" draggable="true">
                        <span class="cube-icon">${cube.emoji}</span>
                        <span class="cube-name">${cube.name}</span>
                        ${countBadge}
                        ${weightBadge}
                    </div>
                `;
            }

            grid.innerHTML = html;
            setupCubesDragAndDrop();
            updateSelectionButton();
            updateUndoRedoButtons();
        }

        async function generatePackingSummary() {
            const btn = document.querySelector('.summary-btn');
            btn.disabled = true;
            btn.textContent = ' Thinking...';

            // Show loading state in panel
            document.getElementById('summary-content').innerHTML = '<div style="color: var(--text-muted);">Generating summary...</div>';
            document.getElementById('packing-summary').style.display = 'block';

            // Build the current state for the LLM
            const packedItems = [];
            const unpackedItems = [];
            const bagContents = {};

            for (const [cubeId, cube] of Object.entries(packingCubes)) {
                bagContents[cube.name] = {
                    emoji: cube.emoji,
                    items: cube.items.map(id => itemStates[id]?.name || id)
                };
            }

            for (const [itemId, state] of Object.entries(itemStates)) {
                if (state.packed || state.cube) {
                    packedItems.push(state.name);
                } else {
                    unpackedItems.push(state.name);
                }
            }

            const prompt = `Generate a brief packing summary for this trip. Be concise and helpful.

Packed items (${packedItems.length}): ${packedItems.join(', ')}
Unpacked items (${unpackedItems.length}): ${unpackedItems.join(', ')}

Bag organization:
${Object.entries(bagContents).map(([name, b]) => `${b.emoji} ${name}: ${b.items.join(', ')}`).join('\n')}

Provide a brief summary with:
1. Total items packed vs unpacked
2. Any suggestions for items that might be missing
3. A brief readiness assessment

Format your response as HTML with simple tags like <strong>, <ul>, <li>.`;

            try {
                const resp = await fetch(PROXY_URL + '/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [{ role: 'user', content: prompt }],
                        max_tokens: 1000
                    })
                });
                const data = await resp.json();
                if (data.error) throw new Error(data.error.message || 'API error');

                const summary = data.choices[0].message.content.trim();
                document.getElementById('summary-content').innerHTML = summary;

            } catch (e) {
                console.error('Summary error:', e);
                document.getElementById('summary-content').innerHTML = `<div style="color: var(--danger-color);">Summary failed: ${e.message}</div>`;
            }

            btn.disabled = false;
            btn.textContent = ' Summary';
        }

        function closeSummary() {
            document.getElementById('packing-summary').style.display = 'none';
        }

        function printChecklist() {
            const tripName = document.getElementById('list-name').value || 'Packing List';

            // Build bag hierarchy with items
            const bags = [];
            const unpackedItems = [];

            // Collect items not in any bag
            for (const [itemId, state] of Object.entries(itemStates)) {
                if (!state.cube && !state.packed) {
                    unpackedItems.push({
                        name: state.name,
                        count: state.count || 1,
                        weight: state.weight
                    });
                }
            }

            // Collect bags and their contents
            for (const [cubeId, cube] of Object.entries(packingCubes)) {
                if (cube.parentBag) continue; // Skip nested bags, they'll be in parent

                const bagData = {
                    emoji: cube.emoji,
                    name: cube.name,
                    items: [],
                    children: [],
                    totalWeight: getCubeTotalWeight(cubeId)
                };

                // Items in this bag
                for (const itemId of cube.items) {
                    const state = itemStates[itemId];
                    if (state) {
                        bagData.items.push({
                            name: state.name,
                            count: state.count || 1,
                            weight: state.weight
                        });
                    }
                }

                // Nested bags
                const children = getChildCubes(cubeId);
                for (const child of children) {
                    const childData = {
                        emoji: child.emoji,
                        name: child.name,
                        items: [],
                        totalWeight: getCubeTotalWeight(child.id)
                    };
                    for (const itemId of child.items) {
                        const state = itemStates[itemId];
                        if (state) {
                            childData.items.push({
                                name: state.name,
                                count: state.count || 1,
                                weight: state.weight
                            });
                        }
                    }
                    bagData.children.push(childData);
                }

                bags.push(bagData);
            }

            // Generate HTML
            let html = `<!DOCTYPE html>
<html>
<head>
    <title>${tripName} - Packing Checklist</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
            color: #1a1a2e;
            line-height: 1.5;
        }
        h1 {
            font-size: 28px;
            margin-bottom: 8px;
            border-bottom: 3px solid #6366f1;
            padding-bottom: 12px;
        }
        .date {
            color: #666;
            margin-bottom: 32px;
            font-size: 14px;
        }
        .bag {
            margin-bottom: 28px;
            page-break-inside: avoid;
        }
        .bag-header {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            padding: 10px 14px;
            background: linear-gradient(135deg, #f0f0ff 0%, #e8e8ff 100%);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bag-weight {
            font-size: 14px;
            color: #10b981;
            font-weight: 500;
        }
        .items {
            padding-left: 8px;
        }
        .item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .item:last-child { border-bottom: none; }
        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #6366f1;
            border-radius: 4px;
            margin-right: 12px;
            flex-shrink: 0;
        }
        .item-name { flex: 1; }
        .item-count {
            color: #6366f1;
            font-weight: 600;
            margin-left: 8px;
        }
        .item-weight {
            color: #10b981;
            font-size: 13px;
            margin-left: 12px;
        }
        .child-bag {
            margin: 12px 0 12px 20px;
            padding: 12px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 3px solid #6366f1;
        }
        .child-bag-header {
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }
        .unpacked {
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px dashed #ddd;
        }
        .unpacked-header {
            font-size: 18px;
            font-weight: 600;
            color: #f59e0b;
            margin-bottom: 12px;
        }

        /* ========================================
           MOBILE RESPONSIVE STYLES
           ======================================== */

        /* Tablet and small laptop (max-width: 768px) */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }

            .container.wide {
                padding: 12px 16px;
            }

            .hero {
                padding: 24px 16px;
            }

            .hero h1 {
                font-size: 1.8rem;
            }

            .hero-icon {
                font-size: 48px;
            }

            .section {
                padding: 16px;
                border-radius: 16px;
            }

            .toggle-grid {
                gap: 8px;
            }

            .toggle-item {
                padding: 10px;
            }

            .toggle-icon {
                font-size: 20px;
                margin-bottom: 4px;
            }

            .toggle-label {
                font-size: 0.8rem;
            }

            .fab-container {
                bottom: 16px;
                right: 16px;
                gap: 10px;
            }

            .fab {
                width: 50px;
                height: 50px;
                border-radius: 14px;
                font-size: 22px;
            }

            .cubes-grid {
                gap: 12px;
            }

            .packing-cube.size-xxlarge {
                width: 180px;
                height: 180px;
            }

            .packing-cube.size-xlarge {
                width: 140px;
                height: 140px;
            }
        }

        /* Phone (max-width: 640px) - MOBILE-FIRST AGGRESSIVE */
        @media (max-width: 640px) {
            body.no-scroll {
                overflow: auto;
                height: auto;
            }

            .container.wide {
                height: auto;
                padding: 6px 8px !important;
            }

            .hero h1 { font-size: 1.4rem; }
            .hero-subtitle { font-size: 0.85rem; }
            .section-title { font-size: 1rem; }

            /* COMPACT TRIP BAR */
            .trip-bar {
                gap: 4px;
                padding: 2px 0;
                margin-bottom: 4px;
            }

            .trip-bar .app-title {
                display: none !important;
            }

            .trip-info { gap: 6px; }
            .trip-name { font-size: 0.85rem; font-weight: 600; }
            .save-status { font-size: 0.6rem; }

            .trip-actions {
                gap: 3px;
                margin-left: auto;
            }

            .trip-btn {
                padding: 3px 5px;
                font-size: 0.6rem;
            }

            /* Hide Redo and Save Prep */
            .trip-btn:nth-child(2),
            .trip-btn:nth-child(3) {
                display: none;
            }

            #results > .section {
                padding: 6px;
                border-radius: 8px;
            }

            .results-layout {
                flex-direction: column;
                gap: 4px;
            }

            .left-column {
                padding: 8px;
                border-radius: 8px;
            }

            .resize-handle {
                display: none;
            }

            .right-column {
                width: 100%;
                margin-top: 0;
            }

            .sticky-header {
                padding: 4px 0 6px 0;
                margin: -4px -8px 4px -8px;
                padding-left: 8px;
                padding-right: 8px;
            }

            /* HIDE DROP ZONES - bags are enough */
            .drop-zones {
                display: none !important;
            }

            /* COMPACT BAGS SECTION */
            .cubes-section {
                padding: 6px;
                border-radius: 8px;
            }

            .cubes-header {
                gap: 4px;
                margin-bottom: 4px;
            }

            .cubes-title {
                font-size: 0.85rem;
            }

            /* HORIZONTAL SCROLLING TOOLBAR */
            .cubes-actions {
                display: flex;
                flex-wrap: nowrap;
                gap: 3px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding: 2px 0;
            }

            .search-input {
                width: 70px;
                min-width: 70px;
                padding: 2px 5px;
                font-size: 0.65rem;
                flex-shrink: 0;
            }

            .search-input:focus {
                width: 90px;
            }

            .add-cube-btn,
            .summary-btn {
                padding: 2px 5px;
                font-size: 0.6rem;
                white-space: nowrap;
                flex-shrink: 0;
            }

            /* TINY TRASH */
            .cubes-actions .drop-zone.trash {
                width: 28px;
                height: 28px;
                min-width: 28px;
                border-radius: 6px;
                border-width: 1px;
                flex-shrink: 0;
            }

            .cubes-actions .drop-zone.trash .drop-zone-icon {
                font-size: 0.9rem;
            }

            .cubes-actions .drop-zone.trash .drop-zone-label {
                display: none;
            }

            /* SMALL COMPACT BAGS */
            .cubes-grid {
                gap: 5px;
                padding: 4px 0;
                justify-content: flex-start;
            }

            .packing-cube {
                min-width: 50px;
                min-height: 50px;
                padding: 4px;
                padding-bottom: 6px;
                border-radius: 8px;
                border-width: 2px;
            }

            .packing-cube.size-small {
                width: 55px;
                height: 60px;
            }

            .packing-cube.size-medium {
                width: 62px;
                height: 66px;
            }

            .packing-cube.size-large {
                width: 72px;
                height: 76px;
            }

            .packing-cube.size-xlarge {
                width: 85px;
                height: 90px;
            }

            .packing-cube.size-xxlarge {
                width: 100px;
                height: 105px;
            }

            .cube-icon {
                font-size: 16px;
            }

            .cube-name {
                font-size: 0.5rem;
                line-height: 1;
            }

            .cube-count {
                min-width: 14px;
                height: 14px;
                font-size: 0.55rem;
                top: -3px;
                right: -3px;
            }

            .cube-weight {
                font-size: 0.45rem;
                padding: 0 3px;
                bottom: -4px;
            }

            .packing-cube.size-small .cube-icon {
                font-size: 14px;
            }

            .packing-cube.size-small .cube-name {
                font-size: 0.45rem;
            }

            /* COMPACT CATEGORIES & ITEMS */
            .category {
                margin-bottom: 8px;
            }

            .category-header {
                gap: 4px;
                margin-bottom: 4px;
                padding-bottom: 2px;
            }

            .category-icon {
                font-size: 12px;
            }

            .category-name {
                font-size: 0.75rem;
            }

            .item-list {
                gap: 3px;
            }

            .item {
                padding: 3px 5px;
                font-size: 0.7rem;
                gap: 3px;
                border-radius: 4px;
            }

            .item-count {
                padding: 0 3px;
                font-size: 0.6rem;
            }

            .item-weight {
                padding: 0 2px;
                font-size: 0.55rem;
            }

            .add-item-inline {
                width: 20px;
                height: 20px;
                font-size: 0.75rem;
            }

            /* FABs - BOTTOM CENTER */
            .fab-container {
                bottom: 6px;
                right: 50%;
                transform: translateX(50%);
                flex-direction: row;
                gap: 6px;
            }

            .fab {
                width: 36px;
                height: 36px;
                border-radius: 18px;
                font-size: 14px;
            }

            .fab-label {
                display: none;
            }

            /* Hide Todoist on mobile */
            .fab.todoist-fab {
                display: none;
            }

            .popup {
                padding: 10px;
                max-width: 95%;
                border-radius: 10px;
            }

            .popup-title {
                font-size: 0.85rem;
            }

            .emoji-picker {
                padding: 10px;
                border-radius: 10px;
            }

            .emoji-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 3px;
            }

            .emoji-option {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .trips-browser {
                border-radius: 8px;
            }

            .trip-item {
                padding: 6px;
                flex-wrap: wrap;
            }

            .trip-item-actions {
                width: 100%;
                margin-top: 4px;
            }

            .theme-toggle {
                width: 28px;
                height: 28px;
                font-size: 12px;
                top: 4px;
                right: 4px;
                border-radius: 6px;
            }

            .packing-summary {
                padding: 6px;
                margin-top: 6px;
                font-size: 0.7rem;
            }
        }

        /* Small phone (max-width: 400px) */
        @media (max-width: 400px) {
            .container {
                padding: 12px;
            }

            .container.wide {
                padding: 10px 12px;
            }

            .hero {
                padding: 16px 12px;
            }

            .hero h1 {
                font-size: 1.3rem;
            }

            .hero-icon {
                font-size: 40px;
                margin-bottom: 12px;
            }

            .section {
                padding: 14px;
                margin-bottom: 14px;
            }

            .section-header {
                gap: 8px;
                margin-bottom: 14px;
            }

            .section-icon {
                font-size: 20px;
            }

            .section-title {
                font-size: 1rem;
            }

            .toggle-grid {
                grid-template-columns: 1fr 1fr;
                gap: 6px;
            }

            .toggle-item {
                padding: 8px;
                border-radius: 10px;
            }

            .toggle-icon {
                font-size: 18px;
                margin-bottom: 2px;
            }

            .toggle-label {
                font-size: 0.7rem;
            }

            .days-value {
                font-size: 1.6rem;
                min-width: 60px;
            }

            .slider-labels {
                font-size: 0.65rem;
            }

            .btn-generate {
                padding: 14px;
                font-size: 1rem;
                border-radius: 10px;
            }

            .trip-bar {
                padding: 4px 0;
            }

            .trip-bar .app-title {
                font-size: 0.75rem;
            }

            .trip-name {
                font-size: 0.8rem;
                max-width: 90px;
            }

            .save-status {
                font-size: 0.65rem;
            }

            .trip-actions {
                gap: 3px;
            }

            .trip-btn {
                padding: 4px 6px;
                font-size: 0.7rem;
                border-radius: 6px;
            }

            .left-column {
                padding: 12px;
                border-radius: 10px;
            }

            .sticky-header {
                margin: -6px -12px 10px -12px;
                padding: 6px 12px 10px 12px;
            }

            .drop-zones {
                gap: 8px;
            }

            .drop-zone {
                width: 52px;
                height: 52px;
                border-radius: 10px;
                border-width: 2px;
            }

            .drop-zone-icon {
                font-size: 28px;
            }

            .drop-zone-count {
                width: 18px;
                height: 18px;
                font-size: 0.6rem;
                top: -6px;
                right: -6px;
            }

            .cubes-section {
                padding: 10px;
                border-radius: 10px;
            }

            .cubes-title {
                font-size: 0.95rem;
            }

            .cubes-grid {
                gap: 8px;
            }

            .packing-cube {
                padding: 6px;
                padding-bottom: 10px;
                border-radius: 10px;
                border-width: 2px;
            }

            .packing-cube.size-small {
                width: 70px;
                height: 80px;
            }

            .packing-cube.size-medium {
                width: 78px;
                height: 88px;
            }

            .packing-cube.size-large {
                width: 90px;
                height: 95px;
            }

            .packing-cube.size-xlarge {
                width: 105px;
                height: 110px;
            }

            .packing-cube.size-xxlarge {
                width: 130px;
                height: 135px;
            }

            .cube-icon {
                font-size: 20px;
            }

            .cube-name {
                font-size: 0.6rem;
            }

            .cube-count {
                min-width: 18px;
                height: 18px;
                font-size: 0.65rem;
                top: -5px;
                right: -5px;
            }

            .cubes-actions .drop-zone.trash {
                width: 60px;
                height: 60px;
                min-width: 60px;
            }

            .cubes-actions .drop-zone.trash .drop-zone-icon {
                font-size: 1.5rem;
            }

            .category {
                margin-bottom: 16px;
            }

            .category-header {
                gap: 6px;
                margin-bottom: 8px;
                padding-bottom: 6px;
            }

            .category-icon {
                font-size: 16px;
            }

            .category-name {
                font-size: 0.85rem;
            }

            .item {
                padding: 5px 8px;
                font-size: 0.78rem;
                border-radius: 6px;
                gap: 4px;
            }

            .item-count {
                padding: 1px 5px;
                font-size: 0.68rem;
                border-radius: 4px;
            }

            .item-weight {
                padding: 1px 5px;
                font-size: 0.62rem;
            }

            .add-item-inline {
                width: 28px;
                height: 28px;
                font-size: 1rem;
                border-radius: 6px;
            }

            .fab-container {
                bottom: 10px;
                right: 10px;
                gap: 6px;
            }

            .fab {
                width: 42px;
                height: 42px;
                border-radius: 10px;
                font-size: 18px;
            }

            .popup {
                padding: 14px;
                border-radius: 12px;
            }

            .popup-header {
                margin-bottom: 12px;
            }

            .popup-title {
                font-size: 0.95rem;
                gap: 6px;
            }

            .emoji-picker {
                padding: 14px;
                border-radius: 14px;
            }

            .emoji-picker-title {
                font-size: 1rem;
                margin-bottom: 12px;
            }

            .emoji-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 5px;
            }

            .emoji-option {
                width: 36px;
                height: 36px;
                font-size: 18px;
                border-radius: 8px;
            }

            .cube-name-input {
                padding: 10px;
                font-size: 0.9rem;
            }

            .emoji-picker-actions button {
                padding: 10px;
                font-size: 0.85rem;
            }

            .generation-progress-bar {
                width: 250px;
            }

            .generation-title {
                font-size: 1.2rem;
            }

            .packing-summary {
                padding: 12px;
                border-radius: 10px;
            }

            .theme-toggle {
                width: 38px;
                height: 38px;
                border-radius: 10px;
                font-size: 16px;
                top: 12px;
                right: 12px;
            }
        }

        /* Landscape phone orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .hero {
                padding: 12px 16px;
            }

            .hero-icon {
                font-size: 32px;
                margin-bottom: 8px;
            }

            .hero h1 {
                font-size: 1.3rem;
                margin-bottom: 4px;
            }

            .section {
                padding: 12px;
                margin-bottom: 12px;
            }

            .fab-container {
                flex-direction: row;
                bottom: 8px;
                right: 50%;
                transform: translateX(50%);
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .item {
                min-height: 44px;
            }

            .trip-btn {
                min-height: 36px;
            }

            .add-cube-btn,
            .summary-btn {
                min-height: 36px;
            }

            .fab:hover {
                transform: none;
            }

            .packing-cube:hover {
                transform: none;
                box-shadow: none;
            }

            .packing-cube.drag-over {
                transform: scale(1.05);
            }
        }

        /* iPhone safe-area insets */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
            }

            .container {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }

            .container.wide {
                padding-left: max(16px, env(safe-area-inset-left));
                padding-right: max(16px, env(safe-area-inset-right));
            }

            .fab-container {
                bottom: max(16px, calc(env(safe-area-inset-bottom) + 8px));
                right: max(16px, env(safe-area-inset-right));
            }

            .popup-overlay {
                padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            }

            .theme-toggle {
                top: max(16px, calc(env(safe-area-inset-top) + 8px));
                right: max(16px, env(safe-area-inset-right));
            }
        }

        /* Improved iOS scrolling */
        .left-column,
        .right-column {
            -webkit-overflow-scrolling: touch;
        }

        /* =============================================
           MOBILE CLASS-BASED STYLES (JavaScript detected)
           ============================================= */

        /* Trip name edit input (hidden by default) */
        .trip-name-edit {
            display: none;
            font-size: inherit;
            font-weight: inherit;
            font-family: inherit;
            border: 1px solid var(--accent-primary);
            border-radius: 4px;
            padding: 2px 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            width: 120px;
        }

        /* Desktop-only elements */
        .desktop-only {
            display: inline-flex;
        }

        /* Mobile-hide elements (hidden via class) */
        .mobile-hide {
            display: inline-flex;
        }

        /* More FAB (hidden on desktop) */
        .more-fab {
            display: none;
        }

        /* Mobile theme toggle (hidden on desktop) */
        .mobile-theme-toggle {
            display: none;
        }

        /* Mobile menu overlay */
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 300;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 20px;
        }

        .mobile-menu-overlay.active {
            display: flex;
        }

        .mobile-menu {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 8px;
            width: 90%;
            max-width: 320px;
        }

        .mobile-menu button {
            display: block;
            width: 100%;
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 1rem;
            text-align: left;
            cursor: pointer;
            border-radius: 8px;
        }

        .mobile-menu button:hover {
            background: var(--bg-tertiary);
        }

        .mobile-menu .cancel-btn {
            color: var(--danger-color);
            text-align: center;
            margin-top: 8px;
            border-top: 1px solid var(--border-color);
            border-radius: 0;
        }

        /* ========== MOBILE STYLES ========== */
        body.is-mobile {
            font-size: 14px;
        }

        body.is-mobile .container.wide {
            padding: 4px 8px !important;
        }

        /* Hide desktop theme toggle on mobile */
        body.is-mobile .theme-toggle {
            display: none !important;
        }

        /* Show mobile theme toggle - bottom left */
        body.is-mobile .mobile-theme-toggle {
            display: flex !important;
            position: fixed;
            bottom: 8px;
            left: 8px;
            width: 36px;
            height: 36px;
            border-radius: 18px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 16px;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 100;
            cursor: pointer;
        }

        /* HIDE app title on mobile */
        body.is-mobile .trip-bar .app-title {
            display: none !important;
        }

        /* MINIMAL TRIP BAR */
        body.is-mobile .trip-bar {
            gap: 8px;
            padding: 4px 0;
            margin-bottom: 4px;
            border-bottom: none;
        }

        body.is-mobile .trip-info {
            flex: 1;
        }

        body.is-mobile .trip-name {
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
        }

        body.is-mobile .save-status {
            font-size: 0.9rem;
        }

        body.is-mobile #save-icon {
            color: var(--success-color);
        }

        body.is-mobile #save-text {
            display: none;
        }

        body.is-mobile .trip-actions {
            gap: 4px;
        }

        body.is-mobile .trip-btn {
            padding: 6px 8px;
            font-size: 1rem;
            border-radius: 8px;
        }

        body.is-mobile .trip-btn.icon-only {
            padding: 6px 10px;
        }

        body.is-mobile .desktop-only {
            display: none !important;
        }

        /* RESULTS - ITEMS GET 60%, BAGS GET 40% */
        body.is-mobile #results > .section {
            padding: 4px;
            border-radius: 8px;
        }

        body.is-mobile .results-layout {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        body.is-mobile .left-column {
            padding: 8px;
            min-height: 50vh;
            max-height: 55vh;
            border-radius: 8px;
        }

        body.is-mobile .right-column {
            margin-top: 0;
            max-height: 30vh;
        }

        body.is-mobile .sticky-header {
            display: none !important;
        }

        body.is-mobile .drop-zones {
            display: none !important;
        }

        /* ITEMS - BIGGER AND READABLE */
        body.is-mobile .category {
            margin-bottom: 10px;
        }

        body.is-mobile .category-header {
            gap: 6px;
            margin-bottom: 6px;
            padding-bottom: 4px;
        }

        body.is-mobile .category-icon {
            font-size: 14px;
        }

        body.is-mobile .category-name {
            font-size: 0.95rem;
            font-weight: 600;
        }

        body.is-mobile .item-list {
            gap: 4px;
        }

        body.is-mobile .item {
            padding: 8px 10px !important;
            font-size: 0.9rem !important;
            gap: 6px;
            border-radius: 6px;
            min-height: 36px;
        }

        body.is-mobile .item-count {
            padding: 2px 6px;
            font-size: 0.8rem;
        }

        body.is-mobile .item-weight {
            padding: 2px 5px;
            font-size: 0.75rem;
        }

        body.is-mobile .add-item-inline {
            width: 28px;
            height: 28px;
            font-size: 1rem;
        }

        /* MINIMAL BAGS SECTION */
        body.is-mobile .cubes-section {
            padding: 6px;
            border-radius: 8px;
        }

        body.is-mobile .cubes-header {
            margin-bottom: 4px;
        }

        body.is-mobile .cubes-title {
            font-size: 0.85rem;
        }

        /* TOOLBAR - just search and add bag */
        body.is-mobile .cubes-actions {
            display: flex;
            gap: 4px;
            padding: 2px 0;
        }

        body.is-mobile .mobile-hide {
            display: none !important;
        }

        body.is-mobile .search-input {
            width: 80px;
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        body.is-mobile .search-input:focus {
            width: 100px;
        }

        body.is-mobile .add-cube-btn {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        /* COMPACT BAGS */
        body.is-mobile .cubes-grid {
            gap: 6px;
            padding: 4px 0;
        }

        body.is-mobile .packing-cube {
            min-width: 50px !important;
            min-height: 50px !important;
            padding: 4px !important;
            border-radius: 8px;
        }

        body.is-mobile .packing-cube.size-small {
            width: 55px !important;
            height: 60px !important;
        }

        body.is-mobile .packing-cube.size-medium {
            width: 62px !important;
            height: 66px !important;
        }

        body.is-mobile .packing-cube.size-large {
            width: 72px !important;
            height: 76px !important;
        }

        body.is-mobile .packing-cube.size-xlarge {
            width: 85px !important;
            height: 90px !important;
        }

        body.is-mobile .packing-cube.size-xxlarge {
            width: 100px !important;
            height: 105px !important;
        }

        body.is-mobile .cube-icon {
            font-size: 16px !important;
        }

        body.is-mobile .cube-name {
            font-size: 0.55rem !important;
        }

        body.is-mobile .cube-count {
            min-width: 14px !important;
            height: 14px !important;
            font-size: 0.55rem !important;
        }

        body.is-mobile .cube-weight {
            font-size: 0.5rem !important;
        }

        /* FABs - BOTTOM RIGHT, show more button */
        body.is-mobile .fab-container {
            bottom: 8px !important;
            right: 8px !important;
            transform: none !important;
            flex-direction: column !important;
            gap: 6px;
        }

        body.is-mobile .fab {
            width: 40px !important;
            height: 40px !important;
            border-radius: 20px;
            font-size: 14px !important;
        }

        body.is-mobile .fab-label {
            display: none !important;
        }

        body.is-mobile .fab.todoist-fab {
            display: none !important;
        }

        body.is-mobile .fab.more-fab {
            display: flex !important;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 18px !important;
            font-weight: bold;
        }

        body.is-mobile .packing-summary {
            padding: 6px;
            font-size: 0.75rem;
        }

        @media print {
            body { padding: 20px; }
            .bag { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <h1> ${tripName}</h1>
    <div class="date">Generated ${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
`;

            // Render bags
            for (const bag of bags) {
                html += `<div class="bag">
                    <div class="bag-header">
                        <span>${bag.emoji} ${bag.name}</span>
                        ${bag.totalWeight ? `<span class="bag-weight">${formatWeight(bag.totalWeight)}</span>` : ''}
                    </div>
                    <div class="items">`;

                for (const item of bag.items) {
                    html += `<div class="item">
                        <div class="checkbox"></div>
                        <span class="item-name">${item.name}</span>
                        ${item.count > 1 ? `<span class="item-count">${item.count}</span>` : ''}
                        ${item.weight ? `<span class="item-weight">${formatWeight(item.weight * item.count)}</span>` : ''}
                    </div>`;
                }

                // Nested bags
                for (const child of bag.children) {
                    html += `<div class="child-bag">
                        <div class="child-bag-header">
                            <span>${child.emoji} ${child.name}</span>
                            ${child.totalWeight ? `<span class="bag-weight">${formatWeight(child.totalWeight)}</span>` : ''}
                        </div>`;
                    for (const item of child.items) {
                        html += `<div class="item">
                            <div class="checkbox"></div>
                            <span class="item-name">${item.name}</span>
                            ${item.count > 1 ? `<span class="item-count">${item.count}</span>` : ''}
                            ${item.weight ? `<span class="item-weight">${formatWeight(item.weight * item.count)}</span>` : ''}
                        </div>`;
                    }
                    html += `</div>`;
                }

                html += `</div></div>`;
            }

            // Unpacked items
            if (unpackedItems.length > 0) {
                html += `<div class="unpacked">
                    <div class="unpacked-header"> Still to pack</div>
                    <div class="items">`;
                for (const item of unpackedItems) {
                    html += `<div class="item">
                        <div class="checkbox"></div>
                        <span class="item-name">${item.name}</span>
                        ${item.count > 1 ? `<span class="item-count">${item.count}</span>` : ''}
                    </div>`;
                }
                html += `</div></div>`;
            }

            html += `</body></html>`;

            // Open in new window and trigger print
            const printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.onload = () => {
                printWindow.print();
            };
        }

        // Weight estimation functions
        async function estimateWeights() {
            const btn = document.getElementById('estimate-weights-btn');
            btn.disabled = true;
            btn.textContent = ' Estimating...';

            // Collect all items
            const items = [];
            for (const [itemId, state] of Object.entries(itemStates)) {
                items.push({
                    name: state.name,
                    count: state.count || 1,
                    category: state.category || 'Other'
                });
            }

            try {
                const weights = await estimateWeightsViaAI(items);

                // Apply weights to item states
                for (const [itemId, state] of Object.entries(itemStates)) {
                    const weight = weights[state.name];
                    if (weight !== undefined) {
                        state.weight = weight;
                    }
                }

                // Re-render to show weights
                renderPackingList(currentList);
                renderCubes();
                scheduleSave();

                btn.textContent = ' Weights ';
                setTimeout(() => {
                    btn.textContent = ' Weights';
                    btn.disabled = false;
                }, 2000);

            } catch (e) {
                console.error('Weight estimation error:', e);
                btn.textContent = ' Failed';
                setTimeout(() => {
                    btn.textContent = ' Weights';
                    btn.disabled = false;
                }, 2000);
            }
        }

        function formatWeight(grams) {
            if (grams >= 1000) {
                return (grams / 1000).toFixed(1) + 'kg';
            }
            return grams + 'g';
        }

        function getWeightClass(grams) {
            if (grams < 30) return 'weight-tiny';
            if (grams < 100) return 'weight-small';
            if (grams < 300) return 'weight-medium';
            if (grams < 800) return 'weight-large';
            return 'weight-heavy';
        }

        function getCubeTotalWeight(cubeId) {
            const cube = packingCubes[cubeId];
            if (!cube) return 0;

            let total = 0;
            // Sum item weights
            for (const itemId of cube.items) {
                const state = itemStates[itemId];
                if (state && state.weight) {
                    total += state.weight * (state.count || 1);
                }
            }
            // Add child cube weights recursively
            const children = cube.children || [];
            for (const childId of children) {
                total += getCubeTotalWeight(childId);
            }
            return total;
        }

        function getCubeSizeClass(weight) {
            // Minimum size for legibility, scale up based on weight
            if (weight < 200) return 'size-small';
            if (weight < 500) return 'size-medium';
            if (weight < 1500) return 'size-large';
            if (weight < 3000) return 'size-xlarge';
            return 'size-xxlarge';
        }

        function searchItem(query) {
            const autocomplete = document.getElementById('search-autocomplete');

            // Clear previous highlights
            document.querySelectorAll('.packing-cube.search-highlight').forEach(el => {
                el.classList.remove('search-highlight');
            });

            if (!query || query.length < 1) {
                autocomplete.style.display = 'none';
                return;
            }

            const lowerQuery = query.toLowerCase();
            const results = [];

            // Search bags/cubes by name
            for (const [cubeId, cube] of Object.entries(packingCubes)) {
                if (cube.name.toLowerCase().includes(lowerQuery) || cube.emoji.includes(query)) {
                    const location = getContainerLocation(cubeId);
                    results.push({
                        type: 'bag',
                        id: cubeId,
                        name: `${cube.emoji} ${cube.name}`,
                        location: location,
                        cubeId: cubeId
                    });
                }
            }

            // Search items
            for (const [itemId, state] of Object.entries(itemStates)) {
                if (state.name.toLowerCase().includes(lowerQuery)) {
                    const location = getItemLocation(itemId);
                    results.push({
                        type: 'item',
                        id: itemId,
                        name: state.name,
                        location: location,
                        cubeId: state.cube
                    });
                }
            }

            // Show autocomplete dropdown
            if (results.length > 0) {
                autocomplete.innerHTML = results.slice(0, 10).map(r => `
                    <div class="search-result" onclick="selectSearchResult('${r.type}', '${r.id}', '${r.cubeId || ''}')">
                        <span class="search-result-name">${r.name}</span>
                        <span class="search-result-type ${r.type}">${r.type}</span>
                        ${r.location ? `<div class="search-result-location">${r.location}</div>` : ''}
                    </div>
                `).join('');
                autocomplete.style.display = 'block';
            } else {
                autocomplete.innerHTML = '<div class="search-result"><span class="search-result-name" style="color: var(--text-muted);">No results found</span></div>';
                autocomplete.style.display = 'block';
            }
        }

        function getContainerLocation(cubeId) {
            const cube = packingCubes[cubeId];
            if (!cube) return '';

            if (cube.parentBag === 'suitcase') return 'In Suitcase';
            if (cube.parentBag === 'backpack') return 'In Backpack';

            // Check if nested in another cube
            for (const [parentId, parentCube] of Object.entries(packingCubes)) {
                if (parentCube.children && parentCube.children.includes(cubeId)) {
                    const parentLocation = getContainerLocation(parentId);
                    return parentLocation ? `${parentCube.emoji} ${parentCube.name} > ${parentLocation}` : `In ${parentCube.emoji} ${parentCube.name}`;
                }
            }
            return 'Not packed';
        }

        function getItemLocation(itemId) {
            const state = itemStates[itemId];
            if (!state) return '';

            if (state.cube) {
                const cube = packingCubes[state.cube];
                if (cube) {
                    const containerLoc = getContainerLocation(state.cube);
                    return `${cube.emoji} ${cube.name}${containerLoc && containerLoc !== 'Not packed' ? ' > ' + containerLoc : ''}`;
                }
            }
            if (state.bag === 'suitcase') return 'Suitcase (loose)';
            if (state.bag === 'backpack') return 'Backpack (loose)';
            return '';
        }

        function selectSearchResult(type, id, cubeId) {
            const autocomplete = document.getElementById('search-autocomplete');
            const searchInput = document.getElementById('item-search');
            autocomplete.style.display = 'none';
            searchInput.value = '';

            // Clear previous highlights
            document.querySelectorAll('.packing-cube.search-highlight').forEach(el => {
                el.classList.remove('search-highlight');
            });

            if (type === 'bag') {
                // Highlight the bag itself
                const cubeEl = document.querySelector(`[data-cube-id="${id}"]`);
                if (cubeEl) {
                    cubeEl.classList.add('search-highlight');
                    cubeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    showSearchNotice(`${packingCubes[id]?.emoji} ${packingCubes[id]?.name}`, getContainerLocation(id));
                }
            } else if (type === 'item') {
                const location = getItemLocation(id);
                const state = itemStates[id];

                if (cubeId && packingCubes[cubeId]) {
                    // Item is in a cube - highlight the cube
                    const cubeEl = document.querySelector(`[data-cube-id="${cubeId}"]`);
                    if (cubeEl) {
                        cubeEl.classList.add('search-highlight');
                        cubeEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    showSearchNotice(state.name, location);
                } else if (state?.bag) {
                    // Item is loose in a bag - just show notice
                    showSearchNotice(state.name, location);
                } else {
                    // Item not packed - highlight in packing list
                    const itemEl = document.querySelector(`[data-item-id="${id}"]`);
                    if (itemEl) {
                        itemEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        itemEl.style.boxShadow = '0 0 15px rgba(255, 215, 0, 0.6)';
                        setTimeout(() => itemEl.style.boxShadow = '', 2000);
                    }
                    showSearchNotice(state.name, 'Not packed yet');
                }
            }
        }

        function showSearchNotice(itemName, location) {
            // Remove existing notice
            const existing = document.querySelector('.search-notice');
            if (existing) existing.remove();

            if (!location) return;

            const notice = document.createElement('div');
            notice.className = 'search-notice';
            notice.innerHTML = `
                <div class="search-notice-content">
                    <span class="search-notice-text"><strong>${itemName}</strong> is in <span class="search-notice-path">${location}</span></span>
                </div>
            `;
            document.body.appendChild(notice);

            // Auto-dismiss after 4 seconds
            setTimeout(() => notice.remove(), 4000);
        }

        // Close autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            const autocomplete = document.getElementById('search-autocomplete');
            const searchContainer = document.querySelector('.search-container');
            if (autocomplete && searchContainer && !searchContainer.contains(e.target)) {
                autocomplete.style.display = 'none';
            }
        });

        function openEmojiPicker() {
            selectedEmoji = cubeEmojis[0];
            const grid = document.getElementById('emoji-grid');
            grid.innerHTML = cubeEmojis.map((emoji, idx) => `
                <div class="emoji-option ${idx === 0 ? 'selected' : ''}" data-emoji="${emoji}">${emoji}</div>
            `).join('');

            // Add click handlers
            grid.querySelectorAll('.emoji-option').forEach(opt => {
                opt.addEventListener('click', function() {
                    grid.querySelectorAll('.emoji-option').forEach(o => o.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedEmoji = this.dataset.emoji;
                });
            });

            document.getElementById('cube-name-input').value = '';
            document.getElementById('emoji-picker').classList.add('visible');
        }

        function closeEmojiPicker() {
            document.getElementById('emoji-picker').classList.remove('visible');
            selectedEmoji = null;
        }

        function createBagFromSelection() {
            if (selectedItems.length === 0) return;
            const name = window.prompt('Name for new bag?', 'New Bag');
            if (!name) return;
            const emoji = window.prompt('Emoji for the bag?', '') || '';
            const parent = window.prompt('Place into (suitcase/backpack or leave blank for none)?', 'suitcase') || null;

            pushHistory();
            historySuspended = true;
            const cubeId = `cube-${cubeIdCounter++}`;
            packingCubes[cubeId] = {
                emoji,
                name,
                parentBag: null,
                items: [],
                children: []
            };
            if (parent === 'suitcase' || parent === 'backpack') {
                assignCubeToContainer(cubeId, parent);
            } else {
                assignCubeToContainer(cubeId, null);
            }
            for (const itemId of [...selectedItems]) {
                assignToCube(itemId, cubeId);
            }
            historySuspended = false;
            selectedItems = [];
            updateSelectionButton();
            renderCubes();
            renderPackingList(currentList);
            updateProgress();
            scheduleSave();
        }

        function createCube() {
            const name = document.getElementById('cube-name-input').value.trim() || 'Cube';
            if (!selectedEmoji) return;

            const cubeId = `cube-${cubeIdCounter++}`;
            packingCubes[cubeId] = {
                emoji: selectedEmoji,
                name: name,
                parentBag: null,
                items: [],
                children: []
            };

            closeEmojiPicker();
            renderCubes();
            scheduleSave();
        }

        let cubeDragged = false;

        function triggerDropAnimation(cubeId) {
            // Wait for re-render then trigger animation
            setTimeout(() => {
                const cubeEl = document.querySelector(`[data-cube-id="${cubeId}"]`);
                if (cubeEl) {
                    cubeEl.classList.add('drop-received');
                    cubeEl.addEventListener('animationend', () => {
                        cubeEl.classList.remove('drop-received');
                    }, { once: true });
                }
            }, 10);
        }

        function setupCubesDragAndDrop() {
            // Cubes are draggable
            document.querySelectorAll('.packing-cube').forEach(cube => {
                cube.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', 'cube:' + this.dataset.cubeId);
                    this.classList.add('dragging');
                    cubeDragged = true;
                });
                cube.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                    // Reset flag after a short delay to allow click event to check it
                    setTimeout(() => { cubeDragged = false; }, 50);
                });

                // Cubes can receive items
                cube.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const data = e.dataTransfer.types.includes('text/plain');
                    if (data) this.classList.add('drag-over');
                });
                cube.addEventListener('dragleave', function() {
                    this.classList.remove('drag-over');
                });
                cube.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    const data = e.dataTransfer.getData('text/plain');
                    const targetCubeId = this.dataset.cubeId;
                    if (data.startsWith('cube:')) {
                        const draggedCube = data.replace('cube:', '');
                        if (draggedCube === targetCubeId) return;
                        if (isAncestor(draggedCube, targetCubeId)) return; // prevent cycles
                        assignCubeToContainer(draggedCube, targetCubeId);
                        triggerDropAnimation(targetCubeId);
                    } else {
                        const itemId = data;
                        assignToCube(itemId, targetCubeId);
                        triggerDropAnimation(targetCubeId);
                    }
                });

                // Click to view cube contents
                cube.addEventListener('click', function(e) {
                    if (cubeDragged) return; // Don't open modal if we just dragged
                    openCubeModal(this.dataset.cubeId);
                });
            });
        }

        function assignToCube(itemId, cubeId) {
            if (!itemStates[itemId]) return;
            pushHistory();
            const state = itemStates[itemId];

            // Remove from previous location
            if (state.cube) {
                const prevCube = packingCubes[state.cube];
                if (prevCube) {
                    prevCube.items = prevCube.items.filter(id => id !== itemId);
                }
            }
            if (state.bag === 'suitcase') {
                suitcaseItems = suitcaseItems.filter(id => id !== itemId);
            } else if (state.bag === 'backpack') {
                backpackItems = backpackItems.filter(id => id !== itemId);
            }

            // Add to cube
            state.cube = cubeId;
            state.bag = null;
            state.packed = true;
            packingCubes[cubeId].items.push(itemId);

            // Re-render to update UI
            renderPackingList(currentList);
            renderCubes();
            updateProgress();
            updateBagCounts();
            scheduleSave();
        }

        function openCubeModal(cubeId) {
            const cube = packingCubes[cubeId];
            if (!cube) return;

            currentOpenBag = cubeId;
            currentOpenBagType = 'cube';
            document.getElementById('modal-title').innerHTML = `${cube.emoji} ${cube.name}`;

            const container = document.getElementById('modal-items');
            let html = '';

            const breadcrumb = getBreadcrumb(cubeId);
            if (breadcrumb.length > 1) {
                html += `<div style="margin-bottom: 12px; font-size: 0.85rem; color: var(--text-muted);">
                    ${breadcrumb.map((b, idx) => idx === breadcrumb.length - 1 ? `<strong>${b.emoji} ${b.name}</strong>` : `${b.emoji} ${b.name}`).join('  ')}
                </div>`;
            }

            const childCubes = getChildCubes(cubeId);
            if (childCubes.length > 0) {
                html += `<div class="modal-section">
                    <div class="modal-section-title">Bags inside ${cube.name}</div>
                    ${childCubes.map(child => `
                        <div class="modal-sub-bag" onclick="openCubeModal('${child.id}')">
                            <div class="modal-sub-bag-info">
                                <span>${child.emoji} ${child.name}</span>
                                ${(child.items.length + (child.children?.length || 0)) > 0 ? `<span class="modal-sub-bag-count">${child.items.length + (child.children?.length || 0)}</span>` : ''}
                            </div>
                            <button class="modal-item-remove" onclick="event.stopPropagation(); removeCubeFromBag('${child.id}'); openCubeModal('${cubeId}');">Unpack</button>
                        </div>
                    `).join('')}
                </div>`;
            }

            // Show total weight in header if available
            const totalWeight = getCubeTotalWeight(cubeId);
            if (totalWeight > 0) {
                html += `<div style="margin-bottom: 12px; padding: 8px 12px; background: var(--success-bg); border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2rem;"></span>
                    <span style="color: var(--success-color); font-weight: 600;">Total: ${formatWeight(totalWeight)}</span>
                </div>`;
            }

            if (cube.items.length === 0 && childCubes.length === 0) {
                html += '<div class="empty-bag">No items yet. Drag items or bags here!</div>';
            } else if (cube.items.length > 0) {
                for (const itemId of cube.items) {
                    const state = itemStates[itemId];
                    if (state) {
                        const itemWeight = state.weight ? formatWeight(state.weight * (state.count || 1)) : '';
                        const countBadge = `<span class="item-count" onclick="editItemCount('${itemId}')" style="margin-left: 8px;">${state.count || 1}</span>`;
                        const weightBadge = `<span onclick="editItemWeight('${itemId}')" style="color: var(--success-color); font-size: 0.85rem; margin-left: auto; margin-right: 12px; cursor: pointer;">${itemWeight}</span>`;
                        html += `
                            <div class="modal-item">
                                <span>${state.name}</span>${countBadge}
                                ${weightBadge}
                                <button class="modal-item-remove" onclick="removeFromCube('${itemId}', '${cubeId}')">&times;</button>
                            </div>
                        `;
                    }
                }
            }

            if (cube.parentBag) {
                html += `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <button class="add-cube-btn" style="width: 100%;" onclick="removeCubeFromBag('${cubeId}'); openCubeModal('${cubeId}');">
                        Unpack from ${packingCubes[cube.parentBag]?.emoji || ''} ${packingCubes[cube.parentBag]?.name || cube.parentBag}
                    </button>
                </div>`;
            } else if (cubeId !== 'suitcase' && cubeId !== 'backpack') {
                // Show options to put this bag into Suitcase or Backpack
                html += `<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px;">Put into:</div>
                    <div style="display: flex; gap: 8px;">
                        <button class="add-cube-btn" style="flex: 1;" onclick="assignCubeToBag('${cubeId}', 'suitcase'); openCubeModal('${cubeId}');">
                             Suitcase
                        </button>
                        <button class="add-cube-btn" style="flex: 1;" onclick="assignCubeToBag('${cubeId}', 'backpack'); openCubeModal('${cubeId}');">
                             Backpack
                        </button>
                    </div>
                </div>`;
            }

            container.innerHTML = html;
            document.getElementById('modal-add-input').value = '';
            document.getElementById('modal-add-input').placeholder = `Add item to ${cube.name}...`;
            document.getElementById('bag-modal').classList.add('visible');
            document.getElementById('modal-add-input').focus();
        }

        function removeFromCube(itemId, cubeId) {
            if (!itemStates[itemId]) return;
            pushHistory();

            // Remove from cube
            const cube = packingCubes[cubeId];
            if (cube) {
                cube.items = cube.items.filter(id => id !== itemId);
            }

            // Update item state
            itemStates[itemId].cube = null;
            itemStates[itemId].packed = false;

            // Re-render
            renderPackingList(currentList);
            renderCubes();
            updateProgress();
            updateBagCounts();
            scheduleSave();

            // Refresh modal
            openCubeModal(cubeId);
        }

        function removeCubeFromBag(cubeId) {
            assignCubeToContainer(cubeId, null);
        }

        function assignCubeToBag(cubeId, bag) {
            assignCubeToContainer(cubeId, bag);
        }

        function assignCubeToContainer(cubeId, parentId) {
            const cube = packingCubes[cubeId];
            if (!cube) return;
            if (cubeId === parentId) return;
            if (parentId && isAncestor(cubeId, parentId)) return; // prevent cycles
            if (parentId && !packingCubes[parentId]) return;
            pushHistory();

            normalizeCubes();

            // Remove from previous parent
            if (cube.parentBag) {
                const prevParent = packingCubes[cube.parentBag];
                if (prevParent && prevParent.children) {
                    prevParent.children = prevParent.children.filter(id => id !== cubeId);
                }
                if (cube.parentBag === 'suitcase') {
                    suitcaseItems = suitcaseItems.filter(id => id !== cubeId);
                } else if (cube.parentBag === 'backpack') {
                    backpackItems = backpackItems.filter(id => id !== cubeId);
                }
            }

            cube.parentBag = parentId;

            if (parentId) {
                if (packingCubes[parentId]) {
                    if (!packingCubes[parentId].children) packingCubes[parentId].children = [];
                    if (!packingCubes[parentId].children.includes(cubeId)) {
                        packingCubes[parentId].children.push(cubeId);
                    }
                }
                if (parentId === 'suitcase') {
                    if (!suitcaseItems.includes(cubeId)) suitcaseItems.push(cubeId);
                } else if (parentId === 'backpack') {
                    if (!backpackItems.includes(cubeId)) backpackItems.push(cubeId);
                }
            } else {
                // Removing from any parent should drop from bag arrays
                suitcaseItems = suitcaseItems.filter(id => id !== cubeId);
                backpackItems = backpackItems.filter(id => id !== cubeId);
            }

            renderCubes();
            updateBagCounts();
            scheduleSave();
        }

        // Close emoji picker on overlay click
        document.getElementById('emoji-picker').addEventListener('click', function(e) {
            if (e.target === this) closeEmojiPicker();
        });

        // Initialize
        loadTheme();
        updateVisibility();

        // Check login and show appropriate screen
        if (apiKey) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            loadTrips();
            loadTripFromUrl();
        }
        updateSelectionButton();
        updateUndoRedoButtons();
    </script>
    </div><!-- /main-app -->
</body>
</html>
